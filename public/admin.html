<!DOCTYPE html>
<html lang="zxx">

<head>
    <title>Admin Panel - Mweshpra Apartments</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bootstrap.css" rel="stylesheet" type="text/css">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Firebase SDKs v8 (compatible with script tags) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Notifications System (for creating notifications) -->
    <script src="js/notifications.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .admin-container {
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .section-card:hover {
            box-shadow: 0 6px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .section-title {
            color: #667eea;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 28px;
        }
        .tenant-table {
            width: 100%;
            overflow-x: auto;
        }
        .tenant-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .tenant-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .tenant-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tenant-table tr:hover {
            background: #f8f9fa;
        }
        
        .btn-action {
            padding: 8px 16px;
            margin: 2px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .btn-update {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input[type="date"] {
            cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            padding: 5px;
        }
        .bulk-update-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stats-card h3 {
            margin: 0;
            font-size: 36px;
        }
        .stats-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .modal-header h3 {
            margin: 0;
            color: #667eea;
        }
        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .close-modal:hover,
        .close-modal:focus {
            color: #667eea;
        }
        .modal-body .form-group {
            margin-bottom: 20px;
        }
        .modal-body label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        .modal-body input[type="text"],
        .modal-body input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .modal-body input[type="date"] {
            cursor: pointer;
        }
        .modal-footer {
            margin-top: 25px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-save {
            background: #28a745;
            color: white;
        }
        .btn-save:hover {
            background: #218838;
        }
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        .btn-cancel:hover {
            background: #5a6268;
        }
    </style>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCk7rNj_35-C8zrQB0O2S4c9CORNIsqlxQ",
            authDomain: "mweshpra-apartments.firebaseapp.com",
            projectId: "mweshpra-apartments",
            storageBucket: "mweshpra-apartments.firebasestorage.app",
            messagingSenderId: "8486695233",
            appId: "1:8486695233:web:fa68793732171d5bfb71c0",
            measurementId: "G-1FM5TXCL1C",
            databaseURL: "https://mweshpra-apartments-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Verify database connection (non-blocking check)
        try {
            const testRef = database.ref('.info/connected');
            const connectedListener = testRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('âœ“ Firebase Realtime Database connected successfully');
                    testRef.off('value', connectedListener); // Remove listener after success
                } else {
                    // This is normal during initial connection - don't show as error
                    setTimeout(() => {
                        testRef.off('value', connectedListener);
                    }, 5000);
                }
            });
        } catch (error) {
            console.error('Error checking database connection:', error);
        }

        // Admin email
        const adminEmail = "preston.mwendwa@riarauniversity.ac.ke";

        // Check authentication state
        auth.onAuthStateChanged(user => {
            if (user) {
                // Case-insensitive email check
                if (!user.email || user.email.toLowerCase() !== adminEmail.toLowerCase()) {
                    alert("Unauthorized access. Admin access only.");
                    auth.signOut();
                    window.location.href = "login.html";
                } else {
                    document.getElementById("adminEmail").textContent = user.email;
                    // Wait a bit for DOM to be ready, then load data
                    setTimeout(() => {
                    loadTenants();
                    loadStats();
                    loadAllowedEmails();
                    loadAnnouncements();
                    loadMaintenanceRequests();
                    loadCheckoutRequests();
                    }, 100);
                }
            } else {
                alert("Please log in as admin first.");
                window.location.href = "login.html";
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = "login.html";
                });
            }
        }

        // Load all tenants (including pending ones)
        function loadTenants() {
            const tenantsRef = database.ref('tenants');
            const pendingTenantsRef = database.ref('pendingTenants');
            
            Promise.all([
                tenantsRef.once('value'),
                pendingTenantsRef.once('value')
            ]).then(([tenantsSnapshot, pendingSnapshot]) => {
                const tenantsList = document.getElementById("tenantsList");
                tenantsList.innerHTML = "";
                
                let hasTenants = false;

                // Load active tenants
                if (tenantsSnapshot.exists()) {
                    tenantsSnapshot.forEach((childSnapshot) => {
                        hasTenants = true;
                        const tenantId = childSnapshot.key;
                        const data = childSnapshot.val();
                        const finance = data.finance || {};
                        const tenantInfo = data.info || {};

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                            <td>${tenantInfo.email || tenantId}</td>
                            <td>${tenantInfo.fullName || 'N/A'}</td>
                            <td>${tenantInfo.phone || 'N/A'}</td>
                            <td><input type="number" class="form-control" value="${finance.rentDue || 0}" step="100" id="rent-${tenantId}" /></td>
                            <td><input type="date" class="form-control" value="${finance.rentDueDate || ''}" id="rentDate-${tenantId}" /></td>
                            <td><input type="number" class="form-control" value="${finance.walletBalance || 0}" step="100" id="wallet-${tenantId}" /></td>
                            <td><input type="number" class="form-control" value="${finance.waterBill || 0}" step="100" id="water-${tenantId}" /></td>
                            <td><input type="date" class="form-control" value="${finance.waterBillDate || ''}" id="waterDate-${tenantId}" /></td>
                            <td>
                                <button class="btn-action btn-update" onclick="updateTenant('${tenantId}')">
                                    <i class="fa-solid fa-save"></i> Update
                                </button>
                                <button class="btn-action" style="background: #28a745; color: white;" onclick="recordPayment('${tenantId}')">
                                    <i class="fa-solid fa-money-bill"></i> Record Payment
                                </button>
                                <button class="btn-action" style="background: #17a2b8; color: white;" onclick="editTenantDetails('${tenantId}')" title="Edit Meter Number, Account Number, etc.">
                                    <i class="fa-solid fa-edit"></i> Details
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteTenant('${tenantId}', '${tenantInfo.email || tenantId}')">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tenantsList.appendChild(tr);
                    });
                }

                // Load pending tenants (not yet signed up)
                if (pendingSnapshot.exists()) {
                    pendingSnapshot.forEach((childSnapshot) => {
                        hasTenants = true;
                        const emailKey = childSnapshot.key;
                        const data = childSnapshot.val();
                        const finance = data.finance || {};
                        const tenantInfo = data.info || {};
                        const pendingId = 'pending_' + emailKey;

                        const tr = document.createElement("tr");
                        tr.style.backgroundColor = '#fff3cd';
                        tr.innerHTML = `
                            <td>${tenantInfo.email || emailKey}</td>
                            <td><span style="color: #856404;">${tenantInfo.fullName || 'Pending Signup'}</span></td>
                            <td>${tenantInfo.phone || 'Pending'}</td>
                            <td><input type="number" class="form-control" value="${finance.rentDue || 0}" step="100" id="rent-${pendingId}" /></td>
                            <td><input type="date" class="form-control" value="${finance.rentDueDate || ''}" id="rentDate-${pendingId}" /></td>
                            <td><input type="number" class="form-control" value="${finance.walletBalance || 0}" step="100" id="wallet-${pendingId}" /></td>
                            <td><input type="number" class="form-control" value="${finance.maintenanceFee || 0}" step="100" id="maintenance-${pendingId}" /></td>
                            <td><input type="date" class="form-control" value="${finance.maintenanceDueDate || ''}" id="maintenanceDate-${pendingId}" /></td>
                            <td>
                                <button class="btn-action btn-update" onclick="updatePendingTenant('${emailKey}', '${pendingId}')">
                                    <i class="fa-solid fa-save"></i> Update
                                </button>
                                <span style="color: #856404; font-size: 12px;">Pending</span>
                            </td>
                        `;
                        tenantsList.appendChild(tr);
                    });
                }

                if (!hasTenants) {
                    tenantsList.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">No tenants found. Add allowed emails to create tenant entries.</td></tr>';
                }
            }).catch((error) => {
                console.error('Error loading tenants:', error);
                const tenantsList = document.getElementById("tenantsList");
                tenantsList.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color: #dc3545;">Error loading tenants: ' + error.message + '</td></tr>';
            });
        }

        // Update pending tenant (before they sign up)
        function updatePendingTenant(emailKey, pendingId) {
            const rentDue = parseFloat(document.getElementById(`rent-${pendingId}`).value) || 0;
            const rentDueDate = document.getElementById(`rentDate-${pendingId}`).value;
            const walletBalance = parseFloat(document.getElementById(`wallet-${pendingId}`).value) || 0;
            const maintenanceFee = parseFloat(document.getElementById(`maintenance-${pendingId}`).value) || 0;
            const maintenanceDueDate = document.getElementById(`maintenanceDate-${pendingId}`).value;

            const updates = {
                [`pendingTenants/${emailKey}/finance/rentDue`]: rentDue,
                [`pendingTenants/${emailKey}/finance/walletBalance`]: walletBalance,
                [`pendingTenants/${emailKey}/finance/maintenanceFee`]: maintenanceFee
            };

            if (rentDueDate) {
                updates[`pendingTenants/${emailKey}/finance/rentDueDate`] = rentDueDate;
            }
            if (maintenanceDueDate) {
                updates[`pendingTenants/${emailKey}/finance/maintenanceDueDate`] = maintenanceDueDate;
            }

            database.ref().update(updates)
                .then(() => {
                    alert('Pending tenant updated successfully!');
                    loadStats();
                })
                .catch((error) => {
                    alert('Error updating pending tenant: ' + error.message);
                });
        }

        // Load statistics
        function loadStats() {
            const tenantsRef = database.ref('tenants');
            const pendingTenantsRef = database.ref('pendingTenants');
            
            Promise.all([
                tenantsRef.once('value'),
                pendingTenantsRef.once('value')
            ]).then(([tenantsSnapshot, pendingSnapshot]) => {
                let totalRentDue = 0;
                let totalWalletBalance = 0;
                let tenantCount = 0;

                // Count active tenants
                if (tenantsSnapshot.exists()) {
                    tenantsSnapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        const finance = data.finance || {};
                        totalRentDue += parseFloat(finance.rentDue || 0);
                        totalWalletBalance += parseFloat(finance.walletBalance || 0);
                        tenantCount++;
                    });
                }

                // Count pending tenants
                if (pendingSnapshot.exists()) {
                    pendingSnapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        const finance = data.finance || {};
                        totalRentDue += parseFloat(finance.rentDue || 0);
                        totalWalletBalance += parseFloat(finance.walletBalance || 0);
                        tenantCount++;
                    });
                }

                document.getElementById("totalTenants").textContent = tenantCount;
                document.getElementById("totalRentDue").textContent = 'Ksh ' + totalRentDue.toLocaleString();
                document.getElementById("totalWalletBalance").textContent = 'Ksh ' + totalWalletBalance.toLocaleString();
            }).catch((error) => {
                console.error('Error loading stats:', error);
            });
        }

        // Record payment and automatically calculate new rent due
        function recordPayment(tenantId) {
            const tenantRef = database.ref('tenants/' + tenantId);
            tenantRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Tenant not found.');
                    return;
                }

                const tenantData = snapshot.val();
                const finance = tenantData.finance || {};
                const currentRentDue = parseFloat(finance.rentDue || 0);
                const currentWallet = parseFloat(finance.walletBalance || 0);
                const monthlyRent = currentRentDue; // Assume current rent is the monthly amount

                // Prompt for payment amount
                const paymentAmountStr = prompt(`Enter payment amount (Ksh):\n\nCurrent Rent Due: Ksh ${currentRentDue.toLocaleString()}\nWallet Balance: Ksh ${currentWallet.toLocaleString()}`);
                if (!paymentAmountStr) return;

                const paymentAmount = parseFloat(paymentAmountStr);
                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert('Please enter a valid payment amount.');
                    return;
                }

                // Calculate new rent due and wallet balance
                let newRentDue = currentRentDue;
                let newWalletBalance = currentWallet;
                let remainingPayment = paymentAmount;

                // First, apply payment to rent due
                if (newRentDue > 0 && remainingPayment > 0) {
                    if (remainingPayment >= newRentDue) {
                        // Payment covers all rent due
                        remainingPayment -= newRentDue;
                        newRentDue = 0;
                    } else {
                        // Payment partially covers rent due
                        newRentDue -= remainingPayment;
                        remainingPayment = 0;
                    }
                }

                // If payment exceeds rent due, add excess to wallet
                if (remainingPayment > 0) {
                    newWalletBalance = currentWallet + remainingPayment;
                }

                // Calculate next rent due date (one month from now)
                const today = new Date();
                const nextMonth = new Date(today);
                nextMonth.setMonth(today.getMonth() + 1);
                const nextRentDueDate = nextMonth.toISOString().split('T')[0];

                // If rent is fully paid, set next month's rent
                if (newRentDue === 0 && monthlyRent > 0) {
                    newRentDue = monthlyRent;
                }

                // Generate receipt number
                const receiptNumber = 'RCP-' + Date.now() + '-' + tenantId.substring(0, 6).toUpperCase();

                // Update last payment
                const lastPayment = {
                    amount: paymentAmount,
                    date: today.toISOString().split('T')[0]
                };

                // Create payment record for receipt
                const paymentRecord = {
                    amount: paymentAmount,
                    date: today.toISOString().split('T')[0],
                    receiptNumber: receiptNumber,
                    method: 'M-Pesa',
                    rentDueBefore: currentRentDue,
                    rentDueAfter: newRentDue,
                    walletBefore: currentWallet,
                    walletAfter: newWalletBalance,
                    recordedBy: (auth && auth.currentUser) ? auth.currentUser.email : 'Admin',
                    recordedAt: today.toISOString()
                };

                // Confirm payment
                const confirmMsg = `Payment Details:\n\n` +
                    `Payment Amount: Ksh ${paymentAmount.toLocaleString()}\n` +
                    `Previous Rent Due: Ksh ${currentRentDue.toLocaleString()}\n` +
                    `New Rent Due: Ksh ${newRentDue.toLocaleString()}\n` +
                    `New Wallet Balance: Ksh ${newWalletBalance.toLocaleString()}\n\n` +
                    `Receipt Number: ${receiptNumber}\n\n` +
                    `Confirm this payment?`;

                if (!confirm(confirmMsg)) {
                    return;
                }

                // Update database
                const paymentId = database.ref('tenants/' + tenantId + '/payments').push().key;
                const updates = {
                    [`tenants/${tenantId}/finance/rentDue`]: newRentDue,
                    [`tenants/${tenantId}/finance/walletBalance`]: newWalletBalance,
                    [`tenants/${tenantId}/finance/lastPayment`]: lastPayment,
                    [`tenants/${tenantId}/finance/lastPaymentDate`]: today.toISOString().split('T')[0],
                    [`tenants/${tenantId}/payments/${paymentId}`]: paymentRecord
                };

                // Update rent due date if rent was fully paid
                if (currentRentDue > 0 && newRentDue === monthlyRent) {
                    updates[`tenants/${tenantId}/finance/rentDueDate`] = nextRentDueDate;
                }

                database.ref().update(updates)
                    .then(() => {
                        alert(`Payment of Ksh ${paymentAmount.toLocaleString()} recorded successfully!\n\nReceipt Number: ${receiptNumber}\nNew Rent Due: Ksh ${newRentDue.toLocaleString()}\nNew Wallet Balance: Ksh ${newWalletBalance.toLocaleString()}\n\nA receipt has been automatically generated and saved.`);
                        loadTenants();
                        loadStats();
                    })
                    .catch((error) => {
                        console.error('Error recording payment:', error);
                        alert('Error recording payment: ' + error.message);
                    });
            }).catch((error) => {
                console.error('Error loading tenant:', error);
                alert('Error loading tenant data: ' + error.message);
            });
        }

        // Update tenant data
        function updateTenant(tenantId) {
            const rentDueEl = document.getElementById(`rent-${tenantId}`);
            const rentDueDateEl = document.getElementById(`rentDate-${tenantId}`);
            const walletBalanceEl = document.getElementById(`wallet-${tenantId}`);
            const waterBillEl = document.getElementById(`water-${tenantId}`);
            const waterBillDateEl = document.getElementById(`waterDate-${tenantId}`);
            const maintenanceFeeEl = document.getElementById(`maintenance-${tenantId}`);
            const maintenanceDueDateEl = document.getElementById(`maintenanceDate-${tenantId}`);

            if (!rentDueEl || !walletBalanceEl || !waterBillEl) {
                alert('Error: Some form fields are missing. Please refresh the page.');
                return;
            }

            const rentDue = parseFloat(rentDueEl.value) || 0;
            const rentDueDate = rentDueDateEl ? rentDueDateEl.value : '';
            const walletBalance = parseFloat(walletBalanceEl.value) || 0;
            const waterBill = parseFloat(waterBillEl.value) || 0;
            const waterBillDate = waterBillDateEl ? waterBillDateEl.value : '';
            const maintenanceFee = maintenanceFeeEl ? (parseFloat(maintenanceFeeEl.value) || 0) : 0;
            const maintenanceDueDate = maintenanceDueDateEl ? maintenanceDueDateEl.value : '';

            const updates = {
                [`tenants/${tenantId}/finance/rentDue`]: rentDue,
                [`tenants/${tenantId}/finance/walletBalance`]: walletBalance,
                [`tenants/${tenantId}/finance/waterBill`]: waterBill
            };

            if (rentDueDate) {
                updates[`tenants/${tenantId}/finance/rentDueDate`] = rentDueDate;
            }
            if (waterBillDate) {
                updates[`tenants/${tenantId}/finance/waterBillDate`] = waterBillDate;
            }
            if (maintenanceFee > 0) {
                updates[`tenants/${tenantId}/finance/maintenanceFee`] = maintenanceFee;
            }
            if (maintenanceDueDate) {
                updates[`tenants/${tenantId}/finance/maintenanceDueDate`] = maintenanceDueDate;
            }

            database.ref().update(updates)
                .then(() => {
                    alert('Tenant updated successfully!');
                    loadStats();
                })
                .catch((error) => {
                    alert('Error updating tenant: ' + error.message);
                });
        }

        // Delete tenant
        function deleteTenant(tenantId, email) {
            if (confirm(`Are you sure you want to delete tenant: ${email}?`)) {
                database.ref(`tenants/${tenantId}`).remove()
                    .then(() => {
                        alert('Tenant deleted successfully!');
                        loadTenants();
                        loadStats();
                    })
                    .catch((error) => {
                        alert('Error deleting tenant: ' + error.message);
                    });
            }
        }

        // Add new tenant
        function addNewTenant() {
            const email = document.getElementById('newTenantEmail').value.trim();
            const fullName = document.getElementById('newTenantName').value.trim();
            const phone = document.getElementById('newTenantPhone').value.trim();
            const password = document.getElementById('newTenantPassword').value;
            const rentDue = parseFloat(document.getElementById('newTenantRent').value) || 0;
            const rentDueDate = document.getElementById('newTenantRentDate').value;
            const walletBalance = parseFloat(document.getElementById('newTenantWallet').value) || 0;
            const waterBill = parseFloat(document.getElementById('newTenantWater').value) || 0;
            const meterNumber = document.getElementById('newTenantMeter').value.trim();
            const accountNumber = document.getElementById('newTenantAccount').value.trim();
            const moveInDate = document.getElementById('newTenantMoveIn').value;

            if (!email || !fullName || !phone || !password) {
                alert('Please fill in all required fields (Email, Name, Phone, Password)');
                return;
            }

            // Create user in Firebase Auth
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const userId = userCredential.user.uid;
                    
                    // Save tenant data to Realtime Database
                    const tenantData = {
                        info: {
                            email: email,
                            fullName: fullName,
                            phone: phone,
                            meterNumber: meterNumber,
                            accountNumber: accountNumber,
                            moveInDate: moveInDate
                        },
                        finance: {
                            rentDue: rentDue,
                            rentDueDate: rentDueDate || '',
                            walletBalance: walletBalance,
                            waterBill: waterBill,
                            waterBillDate: '',
                            lastPayment: {
                                amount: 0,
                                date: ''
                            },
                            otherFees: []
                        }
                    };

                    return database.ref(`tenants/${userId}`).set(tenantData);
                })
                .then(() => {
                    alert('New tenant added successfully!');
                    document.getElementById('newTenantForm').reset();
                    loadTenants();
                    loadStats();
                })
                .catch((error) => {
                    alert('Error adding tenant: ' + error.message);
                });
        }

        // Bulk update rent for all tenants
        function bulkUpdateRent() {
            const newRentAmount = parseFloat(document.getElementById('bulkRentAmount').value);
            const newRentDate = document.getElementById('bulkRentDate').value;

            if (!newRentAmount || newRentAmount <= 0) {
                alert('Please enter a valid rent amount');
                return;
            }

            if (!newRentDate) {
                alert('Please enter a rent due date');
                return;
            }

            if (!confirm(`Update rent to Ksh ${newRentAmount.toLocaleString()} for all tenants?`)) {
                return;
            }

            const tenantsRef = database.ref('tenants');
            tenantsRef.once('value', (snapshot) => {
                const updates = {};
                snapshot.forEach((childSnapshot) => {
                    const tenantId = childSnapshot.key;
                    updates[`tenants/${tenantId}/finance/rentDue`] = newRentAmount;
                    updates[`tenants/${tenantId}/finance/rentDueDate`] = newRentDate;
                });

                database.ref().update(updates)
                    .then(() => {
                        alert('Rent updated for all tenants successfully!');
                        document.getElementById('bulkRentAmount').value = '';
                        document.getElementById('bulkRentDate').value = '';
                        loadTenants();
                        loadStats();
                    })
                    .catch((error) => {
                        alert('Error updating rent: ' + error.message);
                    });
            });
        }

        // Add other fee to tenant
        function addOtherFee(tenantId) {
            const feeName = prompt('Enter fee name (e.g., Water Bill, Electricity):');
            if (!feeName) return;

            const feeAmount = parseFloat(prompt('Enter fee amount:'));
            if (!feeAmount || feeAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const feeDueDate = prompt('Enter due date (YYYY-MM-DD):');
            if (!feeDueDate) return;

            const tenantRef = database.ref(`tenants/${tenantId}/finance/otherFees`);
            tenantRef.once('value', (snapshot) => {
                const fees = snapshot.val() || [];
                fees.push({
                    name: feeName,
                    amount: feeAmount,
                    dueDate: feeDueDate
                });

                tenantRef.set(fees)
                    .then(() => {
                        alert('Fee added successfully!');
                        loadTenants();
                    })
                    .catch((error) => {
                        alert('Error adding fee: ' + error.message);
                });
            });
        }

        // Load allowed emails
        function loadAllowedEmails() {
            const container = document.getElementById('allowedEmailsContainer');
            if (!container) {
                console.error('allowedEmailsContainer element not found');
                return;
            }

            container.innerHTML = '<p style="color: #666;">Loading...</p>';
            
            if (!database) {
                container.innerHTML = '<p style="color: #dc3545;">Database not initialized. Please refresh the page.</p>';
                console.error('Database is not available');
                return;
            }
            
            const allowedEmailsRef = database.ref('allowedEmails');
            allowedEmailsRef.once('value', (snapshot) => {
                const allowedEmails = snapshot.val() || {};
                console.log('Allowed emails loaded:', allowedEmails);
                
                if (!allowedEmails || Object.keys(allowedEmails).length === 0) {
                    container.innerHTML = '<p style="color: #666;">No allowed emails yet. Add emails to allow tenants to sign up.</p>';
                    return;
                }

                let html = '<ul style="list-style: none; padding: 0;">';
                Object.entries(allowedEmails).forEach(([key, email]) => {
                    // Escape email for HTML to prevent XSS
                    const safeEmail = String(email).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const safeKey = String(key).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    html += `
                        <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fa-solid fa-envelope"></i> ${safeEmail}</span>
                            <button class="btn-action btn-delete" onclick="removeAllowedEmail('${safeKey}', '${safeEmail}')" style="padding: 5px 10px;">
                                <i class="fa-solid fa-trash"></i> Remove
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
            }).catch((error) => {
                console.error('Error loading allowed emails:', error);
                let errorMsg = error.message;
                if (error.code === 'PERMISSION_DENIED') {
                    errorMsg = 'Permission denied. Please check Firebase database rules.';
                } else if (error.code === 'UNAVAILABLE') {
                    errorMsg = 'Database unavailable. Please check if Realtime Database is enabled in Firebase Console.';
                }
                container.innerHTML = '<p style="color: #dc3545;">Error loading allowed emails: ' + errorMsg + '</p>';
            });
        }

        // Add allowed email
        function addAllowedEmail() {
            const emailInput = document.getElementById('newAllowedEmail');
            if (!emailInput) {
                alert('Email input field not found');
                return;
            }

            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            console.log('Adding email to allowed list:', email);
            
            if (!database) {
                alert('Database not initialized. Please refresh the page.');
                console.error('Database is not available');
                return;
            }
            
            const emailLower = email.toLowerCase();
            
            // First, add to allowed emails list
            const allowedEmailsRef = database.ref('allowedEmails');
            const newEmailKey = allowedEmailsRef.push().key;
            
            // Create a temporary placeholder tenant entry (will be updated when they sign up)
            // We'll use a temporary ID that will be replaced with actual UID when they sign up
            const tempTenantId = 'pending_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const placeholderTenantData = {
                info: {
                    email: emailLower,
                    fullName: 'Pending Signup',
                    phone: 'Pending',
                    status: 'pending_signup'
                },
                finance: {
                    rentDue: 0,
                    rentDueDate: '',
                    walletBalance: 0,
                    maintenanceFee: 0,
                    maintenanceDueDate: '',
                    lastPayment: {
                        amount: 0,
                        date: ''
                    },
                    otherFees: []
                },
                allowedEmailKey: newEmailKey
            };
            
            // Save both the allowed email and placeholder tenant
            const updates = {};
            updates[`allowedEmails/${newEmailKey}`] = emailLower;
            updates[`pendingTenants/${emailLower.replace(/[.#$\[\]]/g, '_')}`] = placeholderTenantData;
            
            database.ref().update(updates)
                .then(() => {
                    console.log('Email and placeholder tenant created successfully');
                    alert('Email added to allowed list! A placeholder tenant entry has been created. You can now set their rent and other details. When they sign up, their account will be linked automatically.');
                    emailInput.value = '';
                    loadAllowedEmails();
                    loadTenants(); // Reload tenants to show the new pending tenant
                })
                .catch((error) => {
                    console.error('Error adding email:', error);
                    let errorMsg = error.message;
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMsg = 'Permission denied. Please check Firebase database rules. Make sure authenticated users can write to the database.';
                    } else if (error.code === 'UNAVAILABLE') {
                        errorMsg = 'Database unavailable. Please check if Realtime Database is enabled in Firebase Console.';
                    }
                    alert('Error adding email: ' + errorMsg + '\n\nTROUBLESHOOTING:\n\n1. Enable Realtime Database:\n   - Go to Firebase Console\n   - Click "Realtime Database"\n   - Click "Create Database"\n   - Choose location and "Start in test mode"\n\n2. Update Database Rules:\n   - Go to "Rules" tab\n   - Use: { "rules": { ".read": "auth != null", ".write": "auth != null" } }\n   - Click "Publish"\n\n3. Verify you are logged in as admin\n\n4. Check browser console (F12) for detailed errors');
                });
        }

        // Remove allowed email
        function removeAllowedEmail(key, email) {
            if (confirm(`Remove ${email} from allowed emails?`)) {
                database.ref(`allowedEmails/${key}`).remove()
                    .then(() => {
                        alert('Email removed from allowed list!');
                        loadAllowedEmails();
                    })
                    .catch((error) => {
                        console.error('Error removing email:', error);
                        alert('Error removing email: ' + error.message);
                    });
            }
        }

        // Make functions globally accessible
        window.addAllowedEmail = addAllowedEmail;
        window.removeAllowedEmail = removeAllowedEmail;
        window.loadAllowedEmails = loadAllowedEmails;
        window.updatePendingTenant = updatePendingTenant;
        window.updateTenant = updateTenant;
        window.deleteTenant = deleteTenant;
        window.addNewTenant = addNewTenant;
        window.bulkUpdateRent = bulkUpdateRent;
        window.recordPayment = recordPayment;
        
        // Add announcement
        function addAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const date = document.getElementById('announcementDate').value || new Date().toISOString().split('T')[0];
            
            if (!title || !content) {
                alert('Please fill in title and content');
                return;
            }
            
            const announcement = {
                title: title,
                content: content,
                date: date
            };
            
            database.ref('announcements').push(announcement)
                .then(() => {
                    // Create notifications for all tenants
                    createAnnouncementNotifications(database, title, content);
                    
                    alert('Announcement posted successfully!');
                    document.getElementById('announcementTitle').value = '';
                    document.getElementById('announcementContent').value = '';
                    document.getElementById('announcementDate').value = '';
                    loadAnnouncements();
                })
                .catch(error => {
                    alert('Error posting announcement: ' + error.message);
                });
        }
        
        // Load announcements
        function loadAnnouncements() {
            const container = document.getElementById('announcementsList');
            database.ref('announcements').orderByChild('date').limitToLast(10).once('value', (snapshot) => {
                const announcements = snapshot.val() || {};
                if (Object.keys(announcements).length === 0) {
                    container.innerHTML = '<p style="color: #666;">No announcements yet.</p>';
                    return;
                }
                
                let html = '<ul style="list-style: none; padding: 0;">';
                Object.entries(announcements).reverse().forEach(([key, announcement]) => {
                    html += `
                        <li style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${announcement.title || 'Announcement'}</strong>
                                    <p style="margin: 5px 0; color: #666;">${announcement.content || ''}</p>
                                    <small style="color: #999;">${announcement.date || ''}</small>
                                </div>
                                <button class="btn-action btn-delete" onclick="deleteAnnouncement('${key}')" style="padding: 5px 10px;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
            });
        }
        
        // Delete announcement
        function deleteAnnouncement(key) {
            if (confirm('Delete this announcement?')) {
                database.ref('announcements/' + key).remove()
                    .then(() => {
                        alert('Announcement deleted!');
                        loadAnnouncements();
                    })
                    .catch(error => {
                        alert('Error deleting announcement: ' + error.message);
                    });
            }
        }
        
        window.addAnnouncement = addAnnouncement;
        window.deleteAnnouncement = deleteAnnouncement;
        window.loadVisitorRequests = loadVisitorRequests;
        window.updateVisitorStatus = updateVisitorStatus;
        
        // Load maintenance requests
        function loadMaintenanceRequests() {
            const container = document.getElementById('maintenanceRequestsList');
            if (!container) return;
            
            database.ref('maintenanceRequests').orderByChild('submittedAt').once('value', (snapshot) => {
                const requests = snapshot.val() || {};
                if (Object.keys(requests).length === 0) {
                    container.innerHTML = '<p style="color: #666;">No maintenance requests yet.</p>';
                    return;
                }
                
                let html = '<table class="tenant-table" style="margin-top: 10px;"><thead><tr><th>Ticket #</th><th>Tenant</th><th>Type</th><th>Description</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                Object.entries(requests).reverse().forEach(([key, request]) => {
                    const statusClass = request.status === 'completed' ? 'completed' : (request.status === 'in-progress' ? 'in-progress' : 'pending');
                    const statusText = request.status === 'completed' ? 'Closed' : (request.status === 'in-progress' ? 'In Progress' : 'Pending');
                    html += `
                        <tr>
                            <td><strong style="color: #4A90E2;">${request.ticketNumber || 'N/A'}</strong></td>
                            <td>${request.tenantName || 'N/A'}<br><small style="color: #666;">${request.tenantEmail || ''}</small></td>
                            <td><span class="request-type ${request.type}" style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${request.type || 'Other'}</span></td>
                            <td style="max-width: 300px;">${request.description || ''}</td>
                            <td><span class="request-status ${statusClass}" style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">${statusText}</span></td>
                            <td>${request.date || ''}</td>
                            <td>
                                ${request.status !== 'completed' ? `
                                    <button class="btn-action" style="background: #17a2b8; color: white; margin: 2px;" onclick="updateMaintenanceStatus('${key}', 'in-progress')">
                                        <i class="fa-solid fa-spinner"></i> In Progress
                                    </button>
                                    <button class="btn-action" style="background: #28a745; color: white; margin: 2px;" onclick="updateMaintenanceStatus('${key}', 'completed')">
                                        <i class="fa-solid fa-check"></i> Mark Closed
                                    </button>
                                ` : '<span style="color: #28a745;"><i class="fa-solid fa-check-circle"></i> Closed</span>'}
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            });
        }
        
        // Update maintenance request status
        function updateMaintenanceStatus(requestKey, newStatus) {
            // Get request details first
            database.ref(`maintenanceRequests/${requestKey}`).once('value')
                .then((snapshot) => {
                    const request = snapshot.val();
                    const tenantId = request.tenantId;
                    
                    const updates = {
                        [`maintenanceRequests/${requestKey}/status`]: newStatus
                    };
                    
                    if (newStatus === 'completed') {
                        updates[`maintenanceRequests/${requestKey}/completedDate`] = new Date().toISOString().split('T')[0];
                    }
                    
                    return database.ref().update(updates).then(() => {
                        // Create notification for tenant
                        createMaintenanceNotification(database, tenantId, request, newStatus);
                        return { tenantId, request };
                    });
                })
                .then(() => {
                    alert('Maintenance request status updated!');
                    loadMaintenanceRequests();
                })
                .catch(error => {
                    alert('Error updating status: ' + error.message);
                });
        }
        
        // Create notifications for all tenants when announcement is posted
        function createAnnouncementNotifications(database, title, content) {
            database.ref('tenants').once('value', (snapshot) => {
                if (!snapshot.exists()) return;
                
                snapshot.forEach((childSnapshot) => {
                    const tenantId = childSnapshot.key;
                    if (window.createNotification) {
                        window.createNotification(database, tenantId, {
                            type: 'announcement',
                            title: 'New Announcement: ' + title,
                            message: content.length > 100 ? content.substring(0, 100) + '...' : content,
                            link: '#announcements'
                        });
                    }
                });
            });
        }

        // Create notification for maintenance status update
        function createMaintenanceNotification(database, tenantId, request, status) {
            if (!window.createNotification) return;
            
            let title, message;
            if (status === 'completed') {
                title = 'Maintenance Request Completed';
                message = `Your maintenance request (Ticket #${request.ticketNumber || 'N/A'}) has been completed.`;
            } else if (status === 'in-progress') {
                title = 'Maintenance Request In Progress';
                message = `Your maintenance request (Ticket #${request.ticketNumber || 'N/A'}) is now being worked on.`;
            } else {
                return; // Don't notify for other statuses
            }
            
            window.createNotification(database, tenantId, {
                type: 'maintenance',
                title: title,
                message: message,
                link: '#maintenance'
            });
        }
        
        
        // Load checkout requests
        function loadCheckoutRequests() {
            const container = document.getElementById('checkoutRequestsList');
            if (!container) return;
            
            database.ref('checkoutRequests').once('value', (snapshot) => {
                const requests = snapshot.val() || {};
                if (Object.keys(requests).length === 0) {
                    container.innerHTML = '<p style="color: #666;">No checkout requests yet.</p>';
                    return;
                }
                
                let html = '<table class="tenant-table" style="margin-top: 10px;"><thead><tr><th>Tenant</th><th>Checkout Date</th><th>Reason</th><th>Wallet Balance</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                Object.entries(requests).forEach(([tenantId, request]) => {
                    const statusClass = request.status === 'approved' ? 'approved' : (request.status === 'rejected' ? 'rejected' : 'pending');
                    const statusText = request.status === 'approved' ? 'Approved' : (request.status === 'rejected' ? 'Rejected' : 'Pending');
                    html += `
                        <tr>
                            <td>${request.tenantName || 'N/A'}<br><small style="color: #666;">${request.tenantEmail || ''}</small></td>
                            <td>${request.checkoutDate || '-'}</td>
                            <td style="max-width: 300px;">${request.reason || '-'}</td>
                            <td><strong>Ksh ${(request.walletBalance || 0).toLocaleString()}</strong></td>
                            <td><span class="request-status ${statusClass}" style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">${statusText}</span></td>
                            <td>
                                ${request.status === 'pending' ? `
                                    <button class="btn-action" style="background: #28a745; color: white; margin: 2px;" onclick="updateCheckoutStatus('${tenantId}', 'approved')">
                                        <i class="fa-solid fa-check"></i> Approve
                                    </button>
                                    <button class="btn-action btn-delete" style="margin: 2px;" onclick="updateCheckoutStatus('${tenantId}', 'rejected')">
                                        <i class="fa-solid fa-times"></i> Reject
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            });
        }
        
        // Update checkout request status
        function updateCheckoutStatus(tenantId, newStatus) {
            const updates = {
                [`checkoutRequests/${tenantId}/status`]: newStatus
            };
            
            if (newStatus === 'approved') {
                updates[`checkoutRequests/${tenantId}/approvedDate`] = new Date().toISOString().split('T')[0];
                // Reset wallet balance after approval
                database.ref(`tenants/${tenantId}/finance/walletBalance`).set(0);
            }
            
            database.ref().update(updates)
                .then(() => {
                    alert('Checkout request ' + newStatus + '!');
                    loadCheckoutRequests();
                })
                .catch(error => {
                    alert('Error updating status: ' + error.message);
                });
        }
        
        // Edit tenant details (meter number, account number, etc.)
        function editTenantDetails(tenantId) {
            database.ref(`tenants/${tenantId}/info`).once('value', (snapshot) => {
                const info = snapshot.val() || {};
                
                // Populate form fields
                document.getElementById('editMeterNumber').value = info.meterNumber || '';
                document.getElementById('editAccountNumber').value = info.accountNumber || '';
                document.getElementById('editMoveInDate').value = info.moveInDate || '';
                document.getElementById('editTenantId').value = tenantId;
                
                // Show modal
                document.getElementById('tenantDetailsModal').style.display = 'block';
            });
        }
        
        // Save tenant details from modal
        function saveTenantDetails() {
            const tenantId = document.getElementById('editTenantId').value;
            const meterNumber = document.getElementById('editMeterNumber').value.trim();
            const accountNumber = document.getElementById('editAccountNumber').value.trim();
            const moveInDate = document.getElementById('editMoveInDate').value;
            
            if (!tenantId) {
                alert('Error: Tenant ID not found');
                return;
            }
            
            const updates = {
                [`tenants/${tenantId}/info/meterNumber`]: meterNumber,
                [`tenants/${tenantId}/info/accountNumber`]: accountNumber
            };
            
            if (moveInDate) {
                updates[`tenants/${tenantId}/info/moveInDate`] = moveInDate;
            }
            
            database.ref().update(updates)
                .then(() => {
                    alert('Tenant details updated successfully!');
                    closeTenantDetailsModal();
                    loadTenants();
                })
                .catch(error => {
                    alert('Error updating details: ' + error.message);
                });
        }
        
        // Close tenant details modal
        function closeTenantDetailsModal() {
            document.getElementById('tenantDetailsModal').style.display = 'none';
            document.getElementById('editMeterNumber').value = '';
            document.getElementById('editAccountNumber').value = '';
            document.getElementById('editMoveInDate').value = '';
            document.getElementById('editTenantId').value = '';
        }
        
        window.updateMaintenanceStatus = updateMaintenanceStatus;
        window.updateCheckoutStatus = updateCheckoutStatus;
        window.editTenantDetails = editTenantDetails;
        window.saveTenantDetails = saveTenantDetails;
        window.closeTenantDetailsModal = closeTenantDetailsModal;
        window.loadMaintenanceRequests = loadMaintenanceRequests;
        window.loadCheckoutRequests = loadCheckoutRequests;
    </script>
</head>

<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                    <h1><i class="fa-solid fa-user-shield"></i> Admin Panel</h1>
                    <p style="margin: 0; opacity: 0.9;">Mweshpra Apartments Management System</p>
                </div>
            <div>
                    <span id="adminEmail" style="margin-right: 20px; font-weight: bold;"></span>
                    <button class="btn-action btn-delete" onclick="logout()" style="padding: 10px 20px;">
                        <i class="fa-solid fa-sign-out"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row">
            <div class="col-md-4">
                <div class="stats-card">
                    <h3 id="totalTenants">0</h3>
                    <p>Total Tenants</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h3 id="totalRentDue">Ksh 0</h3>
                    <p>Total Rent Due</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="totalWalletBalance">Ksh 0</h3>
                    <p>Total Wallet Balance</p>
                </div>
            </div>
        </div>

        <!-- Add New Tenant Section -->
        <div class="section-card">
            <h3 class="section-title"><i class="fa-solid fa-user-plus"></i> Add New Tenant</h3>
            <form id="newTenantForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Email <span style="color: red;">*</span></label>
                            <input type="email" id="newTenantEmail" required placeholder="tenant@example.com" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Full Name <span style="color: red;">*</span></label>
                            <input type="text" id="newTenantName" required placeholder="John Doe" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Phone <span style="color: red;">*</span></label>
                            <input type="tel" id="newTenantPhone" required placeholder="0712345678" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Password <span style="color: red;">*</span></label>
                            <input type="password" id="newTenantPassword" required placeholder="Password" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="newTenantRent">Initial Rent Due</label>
                            <input type="number" id="newTenantRent" value="0" step="100" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="newTenantRentDate">Rent Due Date</label>
                            <input type="date" id="newTenantRentDate" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="newTenantWallet">Initial Wallet Balance</label>
                            <input type="number" id="newTenantWallet" value="0" step="100" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="newTenantMaintenance">Maintenance Fee</label>
                            <input type="number" id="newTenantMaintenance" value="0" step="100" />
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addNewTenant()">
                    <i class="fa-solid fa-plus"></i> Add New Tenant
                </button>
            </form>
        </div>

        <!-- Bulk Update Rent Section -->
        <div class="section-card">
            <h3 class="section-title"><i class="fa-solid fa-sync-alt"></i> Bulk Update Rent for All Tenants</h3>
            <div class="bulk-update-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="bulkRentAmount">New Rent Amount (Ksh)</label>
                            <input type="number" id="bulkRentAmount" step="100" placeholder="25000" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="bulkRentDate">Rent Due Date</label>
                            <input type="date" id="bulkRentDate" />
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="bulkUpdateRent()">
                    <i class="fa-solid fa-sync"></i> Update Rent for All Tenants
                </button>
            </div>
        </div>

        <!-- Announcements Management Section -->
        <div class="section-card">
            <h3 class="section-title"><i class="fa-solid fa-bullhorn"></i> Manage Announcements</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Announcement Title</label>
                        <input type="text" id="announcementTitle" class="form-control" placeholder="Enter title">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="announcementDate">Date</label>
                        <input type="date" id="announcementDate" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Announcement Content</label>
                <textarea id="announcementContent" class="form-control" rows="4" placeholder="Enter announcement details..."></textarea>
            </div>
            <button type="button" class="btn-add" onclick="addAnnouncement()">
                <i class="fa-solid fa-plus"></i> Post Announcement
            </button>
            
            <div style="margin-top: 30px;">
                <h4>Recent Announcements</h4>
                <div id="announcementsList" style="margin-top: 20px;">
                    <p style="color: #666;">Loading announcements...</p>
                </div>
            </div>
        </div>

        <!-- Manage Allowed Emails Section -->
        <div class="section-card">
            <h3 class="section-title"><i class="fa-solid fa-envelope"></i> Manage Allowed Emails for Signup</h3>
            <div class="bulk-update-section">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label>Add Email Address (to allow signup)</label>
                            <input type="email" id="newAllowedEmail" placeholder="tenant@example.com" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn-add" onclick="addAllowedEmail()" style="width: 100%;">
                                <i class="fa-solid fa-plus"></i> Add Email
                            </button>
                        </div>
                    </div>
                </div>
                <div id="allowedEmailsList" style="margin-top: 20px;">
                    <h4>Approved Emails:</h4>
                    <div id="allowedEmailsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenants List Section -->
        <div class="section-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="section-title" style="margin: 0;"><i class="fa-solid fa-users"></i> All Tenants</h3>
                <a href="setup-emailjs.html" target="_blank" style="background: #667eea; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">
                    <i class="fa-solid fa-envelope"></i> Setup Email Reminders
                </a>
            </div>
            <div class="tenant-table">
                <table>
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Phone</th>
                    <th>Rent Due (Ksh)</th>
                    <th>Rent Due Date</th>
                    <th>Wallet Balance (Ksh)</th>
                    <th>Water Bill (Ksh)</th>
                    <th>Water Bill Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
                    <tbody id="tenantsList">
                        <tr>
                            <td colspan="9" style="text-align:center; padding:20px;">Loading tenants...</td>
                        </tr>
            </tbody>
        </table>
    </div>
        </div>
    </div>

    <!-- Tenant Details Modal -->
    <div id="tenantDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-edit"></i> Edit Tenant Details</h3>
                <button class="close-modal" onclick="closeTenantDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTenantId" value="">
                <div class="form-group">
                    <label for="editMeterNumber"><i class="fa-solid fa-bolt"></i> Meter Number</label>
                    <input type="text" id="editMeterNumber" placeholder="Enter meter number">
                </div>
                <div class="form-group">
                    <label for="editAccountNumber"><i class="fa-solid fa-hashtag"></i> Account Number</label>
                    <input type="text" id="editAccountNumber" placeholder="Enter account number">
                </div>
                <div class="form-group">
                    <label for="editMoveInDate"><i class="fa-solid fa-calendar-days"></i> Move-In Date (Check-In Date)</label>
                    <input type="date" id="editMoveInDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeTenantDetailsModal()">Cancel</button>
                <button class="btn-save" onclick="saveTenantDetails()">
                    <i class="fa-solid fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('tenantDetailsModal');
            if (event.target == modal) {
                closeTenantDetailsModal();
            }
        }
    </script>

    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="js/bootstrap.js"></script>
</body>

</html>
