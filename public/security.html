<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mweshpra Apartments - Security Portal</title>
    <link href="bootstrap.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Notification helpers -->
    <script src="js/notifications.js"></script>

    <!-- QR Scanner removed - using manual visitor check-in -->

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .security-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .auth-card,
        .security-app {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            position: relative;
            z-index: 1;
        }

        .auth-card {
            max-width: 480px;
            margin: 0 auto;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-card-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-card-header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .auth-card-header p {
            color: #666;
            font-size: 14px;
        }

        .account-type-selector {
            display: flex;
            background: #f5f6fa;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 30px;
            gap: 5px;
        }

        .account-type-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .account-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .account-type-btn:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 14px 18px;
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .login-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .login-message.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .login-message.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: #e9ecef;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            position: relative;
            color: #999;
            font-size: 13px;
        }

        .switch-account-link {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .switch-account-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .switch-account-link a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .security-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 32px;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .dashboard-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .dashboard-section:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .dashboard-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-section h3 i {
            color: #667eea;
        }

        .visitor-row {
            border-bottom: 1px solid #f1f1f1;
            padding: 12px 0;
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .visitor-row:last-child {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            text-transform: capitalize;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.rejected,
        .status-badge.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.checked-in {
            background: #cce5ff;
            color: #004085;
        }

        .status-badge.checked-out {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-badge.registered {
            background: #d1ecf1;
            color: #0c5460;
        }

        #id-capture-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content-capture {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        #id-capture-video, #id-capture-canvas {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .capture-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .visitor-media {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .visitor-media img {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #f0f0f0;
        }

        #qr-reader {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
        }

        .qr-result-card {
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            background: #fdfdfd;
        }

        .qr-result-card h4 {
            margin-bottom: 12px;
        }

        .table-header {
            font-weight: 600;
            color: #666;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr;
        }

        @media(max-width: 900px) {
            .visitor-row,
            .table-header {
                grid-template-columns: 1fr;
            }
        }

        @media(max-width: 600px) {
            .auth-card {
                padding: 30px 20px;
                margin: 20px;
            }

            .auth-card-header h1 {
                font-size: 24px;
            }

            .account-type-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            body {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="security-container">
        <div class="auth-card" id="security-login-card">
            <div class="auth-card-header">
                <h1><i class="fa-solid fa-building"></i> Mweshpra Apartments</h1>
                <p>Welcome back! Please sign in to continue</p>
            </div>

            <div class="account-type-selector">
                <button type="button" class="account-type-btn" id="tenant-account-btn" onclick="switchAccountType('tenant')">
                    <i class="fa-solid fa-user"></i> Tenant Account
                </button>
                <button type="button" class="account-type-btn active" id="security-account-btn" onclick="switchAccountType('security')">
                    <i class="fa-solid fa-shield-halved"></i> Security Account
                </button>
            </div>

            <form id="security-login-form">
                <div class="form-group">
                    <label for="securityEmail"><i class="fa-solid fa-envelope"></i> Email Address</label>
                    <input type="email" id="securityEmail" class="form-control" placeholder="Enter your email address"
                        required>
                </div>
                <div class="form-group">
                    <label for="securityPassword"><i class="fa-solid fa-lock"></i> Password</label>
                    <input type="password" id="securityPassword" class="form-control" placeholder="Enter your password"
                        required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-right-to-bracket"></i> Sign In
                </button>
            </form>

            <div id="security-login-message" class="login-message"></div>

            <div class="switch-account-link" id="switch-account-section" style="display: none;">
                <a href="login.html">
                    <i class="fa-solid fa-arrow-left"></i> Switch to Tenant Login
                </a>
            </div>
        </div>

        <div class="security-app" id="security-app" style="display: none;">
            <div class="security-header">
                <div>
                    <h2 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; font-size: 32px;">
                        <i class="fa-solid fa-shield-halved"></i> Security Control Center
                    </h2>
                    <p class="text-muted" id="security-user-email" style="margin: 5px 0 0 0;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" id="security-logout-btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border: none; padding: 12px 24px; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" id="pending-count-card">
                    <p>Registered Visitors</p>
                    <h3 id="pending-count">0</h3>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);">
                    <p>Visitors Today</p>
                    <h3 id="today-count">0</h3>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);">
                    <p>Total Checked In</p>
                    <h3 id="checked-in-count">0</h3>
                </div>
            </div>

            <div class="dashboard-section">
                <h3><i class="fa-solid fa-list-check"></i> Visitors Awaiting Approval/Check-In</h3>
                <p class="text-muted" style="margin-bottom: 15px;">Visitors waiting for tenant approval or ready to check in</p>
                <div class="table-header">
                    <div>Visitor</div>
                    <div>Tenant / Room</div>
                    <div>Visit</div>
                    <div>Approval Status</div>
                    <div>Actions</div>
                </div>
                <div id="pending-requests"></div>
            </div>

            <div class="dashboard-section">
                <h3><i class="fa-solid fa-users-viewfinder"></i> All Visitor Requests</h3>
                <div class="table-header">
                    <div>Visitor</div>
                    <div>Tenant / Room</div>
                    <div>Visit</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
                <div id="all-requests"></div>
            </div>

            <!-- Manage Visitor Requests Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-user-check"></i> Manage Visitor Requests</h3>
                <p class="text-muted" style="margin-bottom: 15px;">View and manage all visitor requests. Approve or reject visitors pre-registered by tenants.</p>
                <div id="visitorRequestsList">
                    <p style="color: #666; padding: 15px;">Loading visitor requests...</p>
                </div>
            </div>

            <!-- Register New Visitor Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-user-plus"></i> Register New Visitor at Gate</h3>
                <p class="text-muted" style="margin-bottom: 20px;">Fill in visitor details when they arrive at the gate</p>
                <form id="gate-visitor-form" style="display: grid; gap: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Visitor Name *</label>
                            <input type="text" id="gate-visitor-name" required placeholder="Full name" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Phone Number *</label>
                            <input type="tel" id="gate-visitor-phone" required placeholder="0712345678" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Host Name *</label>
                            <select id="gate-host-name" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Select host name...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">House Number *</label>
                            <select id="gate-house-number" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Select house number...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Vehicle Registration (if applicable)</label>
                            <input type="text" id="gate-car-reg" placeholder="e.g., KCA 123A" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ID Photo (Front) *</label>
                            <input type="file" id="gate-id-front" accept="image/*" capture="environment" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <div id="gate-id-front-preview" style="margin-top: 10px; display: none;">
                                <img id="gate-id-front-img" style="max-width: 200px; border-radius: 8px; border: 2px solid #667eea;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ID Photo (Back) *</label>
                            <input type="file" id="gate-id-back" accept="image/*" capture="environment" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <div id="gate-id-back-preview" style="margin-top: 10px; display: none;">
                                <img id="gate-id-back-img" style="max-width: 200px; border-radius: 8px; border: 2px solid #667eea;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="gate-parking-assignment" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Assign Parking Slot</label>
                        <select id="gate-parking-slot" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="">Select parking slot...</option>
                        </select>
                    </div>
                    
                    <button type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <i class="fa-solid fa-check"></i> Check In Visitor
                    </button>
                </form>
            </div>

            <!-- Expected Visitors Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-calendar-check"></i> Expected Visitors Today</h3>
                <p class="text-muted" style="margin-bottom: 15px;">Visitors registered by tenants for today</p>
                <div class="table-header">
                    <div>Visitor</div>
                    <div>Tenant / Room</div>
                    <div>Visit Time</div>
                    <div>ID Status</div>
                    <div>Actions</div>
                </div>
                <div id="expected-visitors"></div>
            </div>

            <!-- Package Management Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-box"></i> Package Delivery Management</h3>
                <div id="package-requests-list">
                    <p style="color: #666; text-align: center; padding: 20px;">Loading package requests...</p>
                </div>
            </div>

            <!-- Parking Management Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-parking"></i> Parking Map Management</h3>
                <p class="text-muted" style="margin-bottom: 20px;">Update parking space status and assign vehicles</p>
                
                <!-- Block Selector -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showParkingBlock('A')" id="parking-block-A" class="btn btn-outline-primary" style="flex: 1; min-width: 100px;">Block A</button>
                    <button onclick="showParkingBlock('B')" id="parking-block-B" class="btn btn-outline-primary" style="flex: 1; min-width: 100px;">Block B</button>
                    <button onclick="showParkingBlock('C')" id="parking-block-C" class="btn btn-outline-primary" style="flex: 1; min-width: 100px;">Block C</button>
                </div>

                <!-- Parking Map -->
                <div id="security-parking-map" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;" id="parking-spaces-grid">
                        <!-- Parking spaces will be generated here -->
                    </div>
                </div>

                <!-- Parking Space Details Modal -->
                <div id="parking-edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #333; margin: 0;">Edit Parking Space</h3>
                            <button onclick="closeParkingEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        <div id="parking-edit-form">
                            <!-- Form will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ID Capture Modal -->
    <div id="id-capture-modal">
        <div class="modal-content-capture"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCk7rNj_35-C8zrQB0O2S4c9CORNIsqlxQ",
            authDomain: "mweshpra-apartments.firebaseapp.com",
            projectId: "mweshpra-apartments",
            storageBucket: "mweshpra-apartments.firebasestorage.app",
            messagingSenderId: "8486695233",
            appId: "1:8486695233:web:fa68793732171d5bfb71c0",
            measurementId: "G-1FM5TXCL1C",
            databaseURL: "https://mweshpra-apartments-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const securityEmails = [
            "Preston.mwendwa@riarauniversity.ac.ke",
            "guard@mweshpra.com"
        ];

        let visitorRefListener = null;

        const loginCard = document.getElementById('security-login-card');
        const appShell = document.getElementById('security-app');
        const loginForm = document.getElementById('security-login-form');
        const loginMessage = document.getElementById('security-login-message');
        const pendingContainer = document.getElementById('pending-requests');
        const allRequestsContainer = document.getElementById('all-requests');
        const userEmailEl = document.getElementById('security-user-email');
        const pendingCountEl = document.getElementById('pending-count');
        const todayCountEl = document.getElementById('today-count');
        const checkedInCountEl = document.getElementById('checked-in-count');
        const tenantBtn = document.getElementById('tenant-account-btn');
        const securityBtn = document.getElementById('security-account-btn');
        const switchAccountSection = document.getElementById('switch-account-section');
        let currentAccountType = 'security';

        // Account type switching function
        window.switchAccountType = function(type) {
            currentAccountType = type;
            
            if (type === 'tenant') {
                // Redirect to tenant login page
                window.location.href = 'login.html';
                return;
            } else {
                // Show security login form
                tenantBtn.classList.remove('active');
                securityBtn.classList.add('active');
                switchAccountSection.style.display = 'none';
            }
        };

        // Show message helper
        function showMessage(message, type) {
            loginMessage.textContent = message;
            loginMessage.className = 'login-message ' + (type || 'error');
            loginMessage.style.display = 'block';
            setTimeout(() => {
                loginMessage.style.display = 'none';
            }, 5000);
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('securityEmail').value.trim().toLowerCase();
            const password = document.getElementById('securityPassword').value;

            if (!email || !password) {
                showMessage('Please fill in all fields.', 'error');
                return;
            }

            // Show loading state
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Signing In...';

            auth.signInWithEmailAndPassword(email, password)
                .then((credential) => {
                    const emailLower = email.toLowerCase();
                    const isAuthorized = securityEmails.some(secEmail => secEmail.toLowerCase() === emailLower);
                    if (!isAuthorized) {
                        auth.signOut();
                        throw new Error('This account is not authorized for the security portal.');
                    }

                    loginMessage.style.display = 'none';
                    loginCard.style.display = 'none';
                    appShell.style.display = 'block';
                    userEmailEl.textContent = credential.user.email;
                    attachVisitorsListener();
                    setTimeout(() => {
                        loadHouseNumbers();
                        loadExpectedVisitors();
                        loadPackageRequests();
                        loadParkingData();
                        initializeGateVisitorForm();
                        // Initialize parking block A by default
                        if (document.getElementById('parking-block-A')) {
                            showParkingBlock('A');
                        }
                    }, 500);
                })
                .catch((error) => {
                    let errorMessage = 'Login failed. Please try again.';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    showMessage(errorMessage, 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
        });

        document.getElementById('security-logout-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
                detachVisitorsListener();
                auth.signOut().finally(() => {
                    appShell.style.display = 'none';
                    loginCard.style.display = 'block';
                    loginForm.reset();
                    loginMessage.style.display = 'none';
                });
            }
        });

        // Monitor auth state to prevent unexpected logouts
        auth.onAuthStateChanged((user) => {
            if (!user && appShell.style.display !== 'none') {
                // User was logged out unexpectedly
                console.log('User logged out, but keeping session if authorized');
                // Don't redirect if we're in the middle of scanning
                if (!html5QrCodeInstance) {
                    appShell.style.display = 'none';
                    loginCard.style.display = 'block';
                }
            } else if (user && appShell.style.display === 'none' && loginCard.style.display === 'none') {
                // User is logged in, make sure app is visible
                const emailLower = user.email.toLowerCase();
                const isAuthorized = securityEmails.some(secEmail => secEmail.toLowerCase() === emailLower);
                if (isAuthorized) {
                    appShell.style.display = 'block';
                    loginCard.style.display = 'none';
                    userEmailEl.textContent = user.email;
                    attachVisitorsListener();
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            detachVisitorsListener();
        });

        function attachVisitorsListener() {
            detachVisitorsListener();
            visitorRefListener = database.ref('visitorRequests');
            visitorRefListener.on('value', (snapshot) => {
                const requests = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const data = child.val();
                        if (data) {
                            requests.push({ id: child.key, requestId: child.key, ...data });
                        }
                    });
                }
                // Sort by registeredAt or createdAt (most recent first)
                requests.sort((a, b) => {
                    const dateA = new Date(a.registeredAt || a.createdAt || 0);
                    const dateB = new Date(b.registeredAt || b.createdAt || 0);
                    return dateB - dateA; // Most recent first
                });
                renderVisitorData(requests);
            }, (error) => {
                console.error('Error loading visitors:', error);
                alert('Error loading visitors: ' + error.message);
            });
        }

        function detachVisitorsListener() {
            if (visitorRefListener) {
                visitorRefListener.off();
                visitorRefListener = null;
            }
        }

        function renderVisitorData(requests) {
            const today = new Date().toISOString().split('T')[0];
            let registeredCount = 0;
            let todayCount = 0;
            let checkedInCount = 0;
            let totalVisitorCount = 0;

            const pendingRequests = []; // Visitors awaiting approval or check-in
            const allRequests = [];

            requests.forEach((req) => {
                // Normalize status (handle null/undefined)
                const status = req.status || 'pending';
                
                // Count pending-verification, registered, and approved (awaiting check-in) visitors
                if (status === 'pending-verification' || status === 'registered' || status === 'pending' || (status === 'checked-in' && !req.checkedInAt)) {
                    registeredCount++;
                }
                if (req.visitDate === today) todayCount++;
                if (status === 'checked-in' && req.checkedInAt) {
                    checkedInCount++;
                    totalVisitorCount += (req.numberOfVisitors || 1);
                }

                // Show pending-verification, registered, and approved (awaiting security check-in) visitors in pending section
                if (status === 'pending-verification' || status === 'registered' || status === 'pending' || (status === 'checked-in' && !req.checkedInAt)) {
                    pendingRequests.push(req);
                }
                allRequests.push(req);
            });
            
            // Sort pending requests by date (most recent first)
            pendingRequests.sort((a, b) => {
                const dateA = new Date(a.registeredAt || a.createdAt || 0);
                const dateB = new Date(b.registeredAt || b.createdAt || 0);
                return dateB - dateA;
            });

            if (pendingCountEl) pendingCountEl.textContent = registeredCount;
            if (todayCountEl) todayCountEl.textContent = todayCount;
            if (checkedInCountEl) checkedInCountEl.textContent = totalVisitorCount;

            if (pendingContainer) {
                pendingContainer.innerHTML = pendingRequests.length ? pendingRequests.map(renderVisitorRow).join('') :
                    '<p class="text-muted" style="padding: 15px; text-align: center;">No visitors awaiting approval or check-in.</p>';
            }

            if (allRequestsContainer) {
                allRequestsContainer.innerHTML = allRequests.length ? allRequests.map(renderVisitorRow).join('') :
                    '<p class="text-muted" style="padding: 15px;">No visitor requests found.</p>';
            }

            // Also update expected visitors
            loadExpectedVisitors();
        }

        function renderVisitorRow(request) {
            // Normalize status
            const status = request.status || 'pending';
            const visitInfo = `${request.visitDate || '-'} ${request.visitTime || ''}`;
            const statusClass = `status-badge ${status}`;
            const carInfo = request.carPlate ? `<div style="color:#777; font-size:12px;"><i class="fa-solid fa-car-side"></i> ${request.carPlate}</div>` : '';
            const visitorCount = request.numberOfVisitors ? `<div style="color:#777; font-size:12px;"><i class="fa-solid fa-users"></i> ${request.numberOfVisitors} visitor(s)</div>` : '';

            const mediaHtml = request.idPhoto ? `
                <div class="visitor-media">
                    <img src="${request.idPhoto}" alt="ID Photo" style="cursor: pointer;" onclick="showIdImage('${request.idPhoto}', '${request.idPhotoBack || ''}')">
                </div>
            ` : '';

            // Determine approval status - show "Approved" or "Not Approved" clearly
            let approvalStatus = '';
            if (status === 'pending-verification') {
                approvalStatus = '<span class="status-badge pending" style="background: #fff3cd; color: #856404; font-weight: 600; padding: 6px 12px; border-radius: 6px; display: inline-block;"><i class="fa-solid fa-clock"></i> Not Approved - Awaiting Tenant</span>';
            } else if (status === 'checked-in' && !request.checkedInAt) {
                approvalStatus = '<span class="status-badge approved" style="background: #d4edda; color: #155724; font-weight: 600; padding: 6px 12px; border-radius: 6px; display: inline-block;"><i class="fa-solid fa-check-circle"></i> Approved - Ready for Check-In</span>';
            } else if (status === 'checked-in' && request.checkedInAt) {
                approvalStatus = '<span class="status-badge approved" style="background: #d4edda; color: #155724; font-weight: 600; padding: 6px 12px; border-radius: 6px; display: inline-block;"><i class="fa-solid fa-check-circle"></i> Approved & Checked In</span>';
            } else if (status === 'rejected') {
                approvalStatus = '<span class="status-badge rejected" style="background: #f8d7da; color: #721c24; font-weight: 600; padding: 6px 12px; border-radius: 6px; display: inline-block;"><i class="fa-solid fa-times-circle"></i> Not Approved - Rejected by Tenant</span>';
            } else if (status === 'registered') {
                approvalStatus = '<span class="status-badge registered" style="background: #d1ecf1; color: #0c5460; padding: 6px 12px; border-radius: 6px; display: inline-block;"><i class="fa-solid fa-user-check"></i> Registered</span>';
            } else {
                approvalStatus = `<span class="${statusClass}" style="padding: 6px 12px; border-radius: 6px; display: inline-block;">${status.replace('-', ' ')}</span>`;
            }

            return `
                <div class="visitor-row">
                    <div>
                        <strong>${request.visitorName || 'N/A'}</strong>
                        <div style="color:#777; font-size:12px;">${request.visitorContact || ''}</div>
                        ${visitorCount}
                        ${carInfo}
                        <div style="color:#999; font-size:12px;">Code: ${request.securityCode || '-'}</div>
                        ${mediaHtml}
                    </div>
                    <div>
                        <strong>${request.tenantName || 'Tenant'}</strong>
                        <div style="color:#777; font-size:12px;">${request.tenantEmail || ''}</div>
                        ${request.roomNumber ? `<div style="color:#999; font-size:12px;">Room: ${request.roomNumber}</div>` : ''}
                    </div>
                    <div>${visitInfo}</div>
                    <div>${approvalStatus}</div>
                    <div>
                        ${renderActionButtons(request)}
                    </div>
                </div>
            `;
        }

        function showIdImage(frontImage, backImage) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">&times;</button>
                    <h3 style="margin-bottom: 15px;">ID Photos</h3>
                    <div style="display: grid; grid-template-columns: ${backImage ? '1fr 1fr' : '1fr'}; gap: 15px;">
                        <div>
                            <p style="font-weight: 600; margin-bottom: 10px;">Front</p>
                            <img src="${frontImage}" style="max-width: 100%; border-radius: 8px; border: 2px solid #667eea;">
                        </div>
                        ${backImage ? `
                            <div>
                                <p style="font-weight: 600; margin-bottom: 10px;">Back</p>
                                <img src="${backImage}" style="max-width: 100%; border-radius: 8px; border: 2px solid #667eea;">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
        }

        function renderActionButtons(request) {
            const buttons = [];
            const requestKey = request.id || request.requestId;
            if (!requestKey) return '<span style="color:#999; font-size:12px;">No actions</span>';

            // Normalize status
            const status = request.status || 'pending';

            // Show check-in button only if tenant has approved (status is checked-in means tenant verified)
            if (status === 'checked-in' && !request.checkedInAt) {
                // Tenant approved, now security can check in
                buttons.push(`<button class="btn btn-sm btn-success" onclick="securityCheckInVisitor('${requestKey}')" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;"><i class="fa-solid fa-door-open"></i> Check-In</button>`);
            } else if (status === 'checked-in' && request.checkedInAt) {
                // Already checked in, show check-out
                buttons.push(`<button class="btn btn-sm btn-secondary" onclick="checkOutVisitor('${requestKey}')" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;"><i class="fa-solid fa-door-closed"></i> Check-Out</button>`);
                if (request.checkedInAt) {
                    buttons.push(`<div style="color:#28a745; font-size:11px; margin-top:5px; font-weight: 600;"><i class="fa-solid fa-clock"></i> Checked in: ${formatDateTime(request.checkedInAt)}</div>`);
                }
            } else if (status === 'pending-verification') {
                buttons.push(`<span style="color:#ffc107; font-size:12px; font-weight: 600;"><i class="fa-solid fa-hourglass-half"></i> Waiting for tenant approval</span>`);
            } else if (status === 'rejected') {
                buttons.push(`<span style="color:#dc3545; font-size:12px; font-weight: 600;"><i class="fa-solid fa-ban"></i> Rejected by tenant</span>`);
            }

            if (buttons.length === 0) {
                return '<span style="color:#999; font-size:12px;">No actions</span>';
            }

            return buttons.join('&nbsp;');
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleString('en-KE', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        let currentCheckInRequestId = null;
        let idCaptureStream = null;

        // Security check-in after tenant approval
        window.securityCheckInVisitor = function(requestId) {
            if (!confirm('Check in this visitor? They have been approved by the tenant.')) return;
            
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    
                    // Check if tenant has approved (status should be 'checked-in' which means tenant verified)
                    if (request.status !== 'checked-in') {
                        alert('Visitor must be approved by tenant first. Current status: ' + (request.status || 'pending'));
                        return;
                    }
                    
                    // Check if already checked in
                    if (request.checkedInAt) {
                        alert('Visitor is already checked in.');
                        return;
                    }
                    
                    const now = new Date();
                    const checkInTime = now.toTimeString().split(' ')[0].substring(0, 5);
                    const checkInDate = now.toISOString().split('T')[0];
                    const updates = {
                        checkedInAt: now.toISOString(),
                        checkedInBy: auth.currentUser ? auth.currentUser.email : 'Security',
                        checkInTime: checkInTime,
                        checkInDate: checkInDate,
                        updatedAt: now.toISOString()
                    };
                    
                    return database.ref(`visitorRequests/${requestId}`).update(updates).then(() => {
                        // Notify tenant
                        if (window.createNotification && request.tenantId) {
                            window.createNotification(database, request.tenantId, {
                                type: 'visitor',
                                title: 'Visitor Checked In',
                                message: `${request.visitorName || 'Visitor'} has been checked in at ${checkInTime} on ${checkInDate}.`,
                                link: '#visitors'
                            });
                        }
                        alert(`Visitor checked in successfully!\nTime: ${checkInTime}\nDate: ${checkInDate}`);
                    });
                })
                .catch((error) => {
                    alert('Error checking in visitor: ' + error.message);
                });
        };
        
        // Check-out visitor
        window.checkOutVisitor = function(requestId) {
            if (!confirm('Check out this visitor?')) return;
            
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    
                    const now = new Date();
                    const checkOutTime = now.toTimeString().split(' ')[0].substring(0, 5);
                    const checkOutDate = now.toISOString().split('T')[0];
                    const updates = {
                        status: 'checked-out',
                        checkedOutAt: now.toISOString(),
                        checkedOutBy: auth.currentUser ? auth.currentUser.email : 'Security',
                        checkOutTime: checkOutTime,
                        checkOutDate: checkOutDate,
                        updatedAt: now.toISOString()
                    };
                    
                    // Free up parking if assigned
                    if (request.carPlate) {
                        database.ref('parkingSpaces').once('value').then(parkingSnapshot => {
                            parkingSnapshot.forEach((child) => {
                                const space = child.val();
                                if (space.visitorId === requestId || (space.vehicle === request.carPlate && space.status === 'visitor')) {
                                    database.ref(`parkingSpaces/${child.key}`).update({
                                        status: 'available',
                                        vehicle: null,
                                        owner: null,
                                        tenant: null,
                                        visitorId: null
                                    });
                                }
                            });
                        });
                    }
                    
                    return database.ref(`visitorRequests/${requestId}`).update(updates).then(() => {
                        // Notify tenant
                        if (window.createNotification && request.tenantId) {
                            window.createNotification(database, request.tenantId, {
                                type: 'visitor',
                                title: 'Visitor Checked Out',
                                message: `${request.visitorName || 'Visitor'} has checked out at ${checkOutTime} on ${checkOutDate}.`,
                                link: '#visitors'
                            });
                        }
                        alert(`Visitor checked out successfully!\nTime: ${checkOutTime}\nDate: ${checkOutDate}`);
                        // The listener will automatically update the UI, but force a refresh to be sure
                        setTimeout(() => {
                            database.ref('visitorRequests').once('value').then(snapshot => {
                                const requests = [];
                                if (snapshot.exists()) {
                                    snapshot.forEach((child) => {
                                        const data = child.val();
                                        if (data) {
                                            requests.push({ id: child.key, ...data });
                                        }
                                    });
                                }
                                renderVisitorData(requests);
                            });
                        }, 300);
                    });
                })
                .catch((error) => {
                    alert('Error checking out visitor: ' + error.message);
                });
        };

        function showIdCaptureModal(request) {
            const modal = document.getElementById('id-capture-modal');
            const modalContent = modal.querySelector('.modal-content-capture');
            modalContent.innerHTML = `
                <h3><i class="fa-solid fa-camera"></i> Check-In Visitor: ${request.visitorName || 'N/A'}</h3>
                <p><strong>Number of Visitors:</strong> ${request.numberOfVisitors || 1}</p>
                <p><strong>Tenant:</strong> ${request.tenantName || 'N/A'} (Room: ${request.roomNumber || 'N/A'})</p>
                <p style="color: #666; margin-bottom: 20px;">Please capture or upload the visitor's ID photo for records.</p>
                
                <div id="camera-section">
                    <video id="id-capture-video" autoplay playsinline style="display: none;"></video>
                    <div id="camera-error" style="display: none; padding: 20px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #856404; margin: 0;"><i class="fa-solid fa-exclamation-triangle"></i> <strong>Camera access denied.</strong> Please use the file upload option below or grant camera permissions in your browser settings.</p>
                    </div>
                </div>
                
                <div id="upload-section" style="margin-top: 15px;">
                    <label for="id-upload-input" style="display: block; margin-bottom: 10px; font-weight: 600;">
                        <i class="fa-solid fa-upload"></i> Or Upload ID Photo:
                    </label>
                    <input type="file" id="id-upload-input" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                </div>
                
                <canvas id="id-capture-canvas" style="display: none;"></canvas>
                <div id="id-capture-preview" style="display: none; text-align: center; margin: 15px 0;">
                    <img id="id-preview-img" style="max-width: 100%; border-radius: 8px; border: 2px solid #667eea;">
                    <p style="color: #28a745; margin-top: 10px;"><i class="fa-solid fa-check-circle"></i> ID photo ready</p>
                </div>
                
                <div class="capture-buttons">
                    <button class="btn btn-primary" id="capture-id-btn" onclick="captureIdPhoto()" style="display: none;">
                        <i class="fa-solid fa-camera"></i> Capture from Camera
                    </button>
                    <button class="btn btn-success" id="confirm-checkin-btn" onclick="confirmCheckIn()" style="display: none;">
                        <i class="fa-solid fa-check"></i> Confirm Check-In
                    </button>
                    <button class="btn btn-secondary" onclick="cancelIdCapture()">
                        <i class="fa-solid fa-times"></i> Cancel
                    </button>
                </div>
            `;
            modal.style.display = 'block';
            
            // Setup file upload handler
            const uploadInput = document.getElementById('id-upload-input');
            if (uploadInput) {
                uploadInput.addEventListener('change', handleIdUpload);
            }
            
            // Try to start camera
            startIdCapture();
        }

        function startIdCapture() {
            const video = document.getElementById('id-capture-video');
            const cameraError = document.getElementById('camera-error');
            const captureBtn = document.getElementById('capture-id-btn');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                if (cameraError) cameraError.style.display = 'block';
                if (captureBtn) captureBtn.style.display = 'none';
                return;
            }

            // Try rear camera first (environment), then fallback to any camera
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then((stream) => {
                    idCaptureStream = stream;
                    if (video) {
                        video.srcObject = stream;
                        video.style.display = 'block';
                    }
                    if (cameraError) cameraError.style.display = 'none';
                    if (captureBtn) captureBtn.style.display = 'inline-block';
                })
                .catch(() => {
                    // Try any available camera as fallback
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then((stream) => {
                            idCaptureStream = stream;
                            if (video) {
                                video.srcObject = stream;
                                video.style.display = 'block';
                            }
                            if (cameraError) cameraError.style.display = 'none';
                            if (captureBtn) captureBtn.style.display = 'inline-block';
                        })
                        .catch((error) => {
                            // Camera access failed - show error and hide camera button
                            if (cameraError) {
                                cameraError.style.display = 'block';
                                let errorMsg = 'Camera access denied. ';
                                if (error.name === 'NotAllowedError') {
                                    errorMsg += 'Please allow camera access in your browser settings and refresh.';
                                } else if (error.name === 'NotFoundError') {
                                    errorMsg += 'No camera found. Please use the file upload option.';
                                } else if (error.name === 'NotReadableError') {
                                    errorMsg += 'Camera is being used by another application. Please close other apps and try again, or use file upload.';
                                } else {
                                    errorMsg += 'Please use the file upload option below.';
                                }
                                cameraError.querySelector('p').innerHTML = `<i class="fa-solid fa-exclamation-triangle"></i> <strong>${error.name}:</strong> ${errorMsg}`;
                            }
                            if (captureBtn) captureBtn.style.display = 'none';
                            if (video) video.style.display = 'none';
                        });
                });
        }
        
        function handleIdUpload(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const canvas = document.getElementById('id-capture-canvas');
                const preview = document.getElementById('id-capture-preview');
                const previewImg = document.getElementById('id-preview-img');
                const confirmBtn = document.getElementById('confirm-checkin-btn');
                const video = document.getElementById('id-capture-video');
                
                if (canvas && preview && previewImg) {
                    const img = new Image();
                    img.onload = function() {
                        // Set canvas size
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        // Show preview
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                        if (video) video.style.display = 'none';
                        if (confirmBtn) confirmBtn.style.display = 'inline-block';
                        
                        // Stop camera if running
                        if (idCaptureStream) {
                            idCaptureStream.getTracks().forEach(track => track.stop());
                            idCaptureStream = null;
                        }
                    };
                    img.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }

        window.captureIdPhoto = function() {
            const video = document.getElementById('id-capture-video');
            const canvas = document.getElementById('id-capture-canvas');
            const preview = document.getElementById('id-capture-preview');
            const previewImg = document.getElementById('id-preview-img');
            const captureBtn = document.getElementById('capture-id-btn');
            const confirmBtn = document.getElementById('confirm-checkin-btn');

            if (!video || !canvas || !preview || !previewImg) {
                alert('Camera elements not found. Please refresh and try again.');
                return;
            }

            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                alert('Camera not ready. Please wait a moment and try again.');
                return;
            }

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                previewImg.src = imageData;
                preview.style.display = 'block';
                video.style.display = 'none';
                if (captureBtn) captureBtn.style.display = 'none';
                if (confirmBtn) confirmBtn.style.display = 'inline-block';

                if (idCaptureStream) {
                    idCaptureStream.getTracks().forEach(track => track.stop());
                    idCaptureStream = null;
                }
            } catch (error) {
                console.error('Error capturing photo:', error);
                alert('Error capturing photo: ' + error.message);
            }
        };

        window.confirmCheckIn = function() {
            const canvas = document.getElementById('id-capture-canvas');
            const previewImg = document.getElementById('id-preview-img');
            
            if (!currentCheckInRequestId) {
                alert('Error: No visitor selected. Please try again.');
                return;
            }

            let idPhotoData = null;
            
            // Get image data from canvas or preview image
            if (canvas && canvas.width > 0 && canvas.height > 0) {
                idPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            } else if (previewImg && previewImg.src) {
                idPhotoData = previewImg.src;
            } else {
                alert('Please capture or upload an ID photo before checking in.');
                return;
            }

            const requestId = currentCheckInRequestId;

            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    const now = new Date();

                    const updates = {
                        [`visitorRequests/${requestId}/status`]: 'checked-in',
                        [`visitorRequests/${requestId}/idPhoto`]: idPhotoData,
                        [`visitorRequests/${requestId}/checkInTime`]: now.toISOString(),
                        [`visitorRequests/${requestId}/checkInYear`]: now.getFullYear(),
                        [`visitorRequests/${requestId}/checkInMonth`]: now.getMonth() + 1,
                        [`visitorRequests/${requestId}/checkInDay`]: now.getDate(),
                        [`visitorRequests/${requestId}/checkInHour`]: now.getHours(),
                        [`visitorRequests/${requestId}/checkInMinute`]: now.getMinutes(),
                        [`visitorRequests/${requestId}/checkedInBy`]: auth.currentUser ? auth.currentUser.email : 'Security',
                        [`visitorRequests/${requestId}/updatedAt`]: now.toISOString()
                    };

                    return database.ref().update(updates).then(() => {
                        createVisitorNotification(database, request.tenantId, request, 'checked-in');
                        cancelIdCapture();
                        alert(`Visitor checked in successfully! Count: ${request.numberOfVisitors || 1}`);
                    });
                })
                .catch((error) => {
                    alert('Error checking in visitor: ' + error.message);
                });
        };

        window.cancelIdCapture = function() {
            // Stop camera stream
            if (idCaptureStream) {
                idCaptureStream.getTracks().forEach(track => track.stop());
                idCaptureStream = null;
            }
            
            // Reset file input
            const uploadInput = document.getElementById('id-upload-input');
            if (uploadInput) {
                uploadInput.value = '';
            }
            
            // Hide modal
            const modal = document.getElementById('id-capture-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            currentCheckInRequestId = null;
        };

        window.updateVisitorStatus = function(requestId, newStatus) {
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    const now = new Date();
                    const updates = {
                        [`visitorRequests/${requestId}/status`]: newStatus,
                        [`visitorRequests/${requestId}/updatedAt`]: now.toISOString()
                    };

                    if (newStatus === 'checked-out') {
                        updates[`visitorRequests/${requestId}/checkOutTime`] = now.toISOString();
                        updates[`visitorRequests/${requestId}/checkOutYear`] = now.getFullYear();
                        updates[`visitorRequests/${requestId}/checkOutMonth`] = now.getMonth() + 1;
                        updates[`visitorRequests/${requestId}/checkOutDay`] = now.getDate();
                        updates[`visitorRequests/${requestId}/checkOutHour`] = now.getHours();
                        updates[`visitorRequests/${requestId}/checkOutMinute`] = now.getMinutes();
                        updates[`visitorRequests/${requestId}/checkedOutBy`] = auth.currentUser ? auth.currentUser.email : 'Security';
                    }

                    return database.ref().update(updates).then(() => {
                        createVisitorNotification(database, request.tenantId, request, newStatus);
                    });
                })
                .catch((error) => {
                    alert('Error updating visitor request: ' + error.message);
                });
        };

        function createVisitorNotification(database, tenantId, request, status) {
            if (!window.createNotification) return;

            let title = 'Visitor Update';
            let message = '';

            if (status === 'checked-in') {
                title = 'Visitor Checked In';
                message = `Your visitor ${request.visitorName || ''} (${request.numberOfVisitors || 1} person(s)) has arrived and checked in.`;
            } else if (status === 'checked-out') {
                title = 'Visitor Checked Out';
                message = `Your visitor ${request.visitorName || ''} has checked out.`;
            } else {
                return;
            }

            window.createNotification(database, tenantId, {
                type: 'visitor',
                title,
                message,
                link: '#visitors'
            });
        }

        // Load Expected Visitors
        function loadExpectedVisitors() {
            const expectedContainer = document.getElementById('expected-visitors');
            if (!expectedContainer) return;

            const today = new Date().toISOString().split('T')[0];
            database.ref('visitorRequests')
                .orderByChild('visitDate')
                .equalTo(today)
                .on('value', (snapshot) => {
                    const visitors = [];
                    snapshot.forEach((child) => {
                        const request = { id: child.key, ...child.val() };
                        if (request.status === 'registered' || request.status === 'pending') {
                            visitors.push(request);
                        }
                    });

                    if (visitors.length === 0) {
                        expectedContainer.innerHTML = '<p class="text-muted" style="padding: 15px; text-align: center;">No expected visitors for today.</p>';
                        return;
                    }

                    expectedContainer.innerHTML = visitors.map(request => {
                        const idStatus = request.idPhoto ? 
                            '<span class="status-badge approved"><i class="fa-solid fa-check"></i> ID Uploaded</span>' : 
                            '<span class="status-badge pending"><i class="fa-solid fa-clock"></i> Awaiting ID</span>';
                        
                        return `
                            <div class="visitor-row">
                                <div>
                                    <strong>${request.visitorName || 'N/A'}</strong>
                                    <div style="color:#777; font-size:12px;">${request.visitorContact || ''}</div>
                                    ${request.carPlate ? `<div style="color:#777; font-size:12px;"><i class="fa-solid fa-car-side"></i> ${request.carPlate}</div>` : ''}
                                </div>
                                <div>
                                    <strong>${request.tenantName || 'Tenant'}</strong>
                                    <div style="color:#777; font-size:12px;">${request.roomNumber || request.apartment || 'N/A'}</div>
                                </div>
                                <div>${request.visitTime || 'N/A'}</div>
                                <div>${idStatus}</div>
                                <div>
                                    ${request.idPhoto ? 
                                        `<button class="btn btn-sm btn-primary" onclick="checkInVisitor('${request.id}')"><i class="fa-solid fa-door-open"></i> Check-In</button>` :
                                        '<span style="color:#999; font-size:12px;">Waiting for ID upload</span>'
                                    }
                                </div>
                            </div>
                        `;
                    }).join('');
                });
        }

        // Load Package Requests
        function loadPackageRequests() {
            const packageContainer = document.getElementById('package-requests-list');
            if (!packageContainer) return;

            database.ref('packageRequests')
                .orderByChild('createdAt')
                .on('value', (snapshot) => {
                    const packages = [];
                    snapshot.forEach((child) => {
                        packages.push({ id: child.key, ...child.val() });
                    });

                    if (packages.length === 0) {
                        packageContainer.innerHTML = '<p class="text-muted" style="padding: 15px; text-align: center;">No package requests.</p>';
                        return;
                    }

                    packageContainer.innerHTML = packages.map(pkg => {
                        const statusBadge = pkg.status === 'pending' ? 
                            '<span class="status-badge pending">Pending</span>' :
                            pkg.status === 'arrived' ?
                            '<span class="status-badge approved">Arrived</span>' :
                            '<span class="status-badge checked-out">Collected</span>';

                        return `
                            <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${pkg.status === 'pending' ? '#ffc107' : pkg.status === 'arrived' ? '#28a745' : '#6c757d'};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <h4 style="color: #333; margin-bottom: 5px;"><i class="fa-solid fa-box"></i> ${pkg.description || 'Package'}</h4>
                                        <p style="color: #666; font-size: 14px; margin: 5px 0;"><strong>Tenant:</strong> ${pkg.tenantName || 'N/A'} (${pkg.apartment || 'N/A'})</p>
                                        <p style="color: #666; font-size: 14px; margin: 5px 0;"><strong>Expected:</strong> ${pkg.expectedDate || 'N/A'}</p>
                                        ${pkg.trackingNumber ? `<p style="color: #666; font-size: 14px; margin: 5px 0;"><strong>Tracking:</strong> ${pkg.trackingNumber}</p>` : ''}
                                    </div>
                                    <div style="margin-left: 15px;">
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    ${pkg.status === 'pending' ? 
                                        `<button class="btn btn-sm btn-success" onclick="markPackageArrived('${pkg.id}')"><i class="fa-solid fa-check"></i> Mark as Arrived</button>` :
                                        pkg.status === 'arrived' ?
                                        `<button class="btn btn-sm btn-secondary" onclick="notifyTenantPackage('${pkg.id}')"><i class="fa-solid fa-bell"></i> Notify Tenant</button>` :
                                        ''
                                    }
                                </div>
                            </div>
                        `;
                    }).join('');
                });
        }

        // Mark package as arrived
        window.markPackageArrived = function(packageId) {
            database.ref(`packageRequests/${packageId}`).update({
                status: 'arrived',
                arrivedAt: new Date().toISOString()
            }).then(() => {
                alert('Package marked as arrived!');
            }).catch(error => {
                alert('Error updating package: ' + error.message);
            });
        };

        // Notify tenant about package
        window.notifyTenantPackage = function(packageId) {
            database.ref(`packageRequests/${packageId}`).once('value').then(snapshot => {
                const pkg = snapshot.val();
                if (window.createNotification) {
                    window.createNotification(database, pkg.tenantId, {
                        type: 'package',
                        title: 'Package Arrived',
                        message: `Your package "${pkg.description || 'Package'}" has arrived and is ready for pickup at the security office.`,
                        link: '#packages'
                    });
                }
                alert('Tenant has been notified about the package!');
            }).catch(error => {
                alert('Error notifying tenant: ' + error.message);
            });
        };

        // Parking Management
        let currentParkingBlock = 'A';
        let parkingData = {};

        function loadParkingData() {
            database.ref('parkingSpaces').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    parkingData = snapshot.val();
                } else {
                    // Initialize with default data
                    initializeParkingData();
                }
                renderParkingMap(currentParkingBlock);
            });
        }

        function initializeParkingData() {
            const defaultData = {};
            ['A', 'B', 'C'].forEach(block => {
                for (let i = 1; i <= 8; i++) {
                    const spaceId = `${block}-${String(i).padStart(2, '0')}`;
                    defaultData[spaceId] = {
                        id: spaceId,
                        block: block,
                        floor: 'Ground',
                        status: 'available',
                        vehicle: null,
                        tenant: null,
                        owner: null
                    };
                }
            });
            database.ref('parkingSpaces').set(defaultData);
            parkingData = defaultData;
        }

        window.showParkingBlock = function(block) {
            currentParkingBlock = block;
            ['A', 'B', 'C'].forEach(b => {
                const btn = document.getElementById(`parking-block-${b}`);
                if (btn) {
                    if (b === block) {
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-primary');
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-primary');
                    }
                }
            });
            renderParkingMap(block);
        };

        function renderParkingMap(block) {
            const grid = document.getElementById('parking-spaces-grid');
            if (!grid) return;

            const spaces = Object.values(parkingData).filter(s => s && s.block === block);
            if (spaces.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No parking spaces found for this block.</p>';
                return;
            }

            // Sort spaces by ID
            spaces.sort((a, b) => {
                const numA = parseInt(a.id?.split('-')[1]) || 0;
                const numB = parseInt(b.id?.split('-')[1]) || 0;
                return numA - numB;
            });

            const isMobile = window.innerWidth < 768;
            const gridColumns = isMobile ? 'repeat(2, 1fr)' : 'repeat(4, 1fr)';
            grid.style.gridTemplateColumns = gridColumns;

            grid.innerHTML = spaces.map(space => {
                let bgColor = '#28a745'; // Available - Green
                let textColor = 'white';
                
                if (space.status === 'occupied') {
                    bgColor = '#dc3545'; // Occupied - Red
                } else if (space.status === 'visitor') {
                    bgColor = '#17a2b8'; // Visitor - Blue
                }

                return `
                    <div onclick="editParkingSpace('${space.id}')" 
                         style="
                             background: ${bgColor};
                             color: ${textColor};
                             padding: ${isMobile ? '12px 8px' : '15px 10px'};
                             border-radius: 10px;
                             text-align: center;
                             cursor: pointer;
                             transition: all 0.3s ease;
                             min-height: ${isMobile ? '75px' : '90px'};
                             display: flex;
                             flex-direction: column;
                             justify-content: center;
                             align-items: center;
                             touch-action: manipulation;
                         " 
                         ${!isMobile ? `onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.2)'"
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"` : ''}>
                        <div style="font-size: ${isMobile ? '13px' : '16px'}; font-weight: 700; margin-bottom: 5px;">${space.id}</div>
                        ${space.vehicle ? `<div style="font-size: ${isMobile ? '9px' : '11px'}; opacity: 0.9; margin-bottom: 3px;">${space.vehicle}</div>` : ''}
                        ${space.owner ? `<div style="font-size: ${isMobile ? '8px' : '10px'}; opacity: 0.8;">${space.owner}</div>` : '<div style="font-size: 8px; opacity: 0.8;">Available</div>'}
                        ${space.tenant ? `<div style="font-size: ${isMobile ? '8px' : '9px'}; opacity: 0.7; margin-top: 2px;">${space.tenant}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        window.editParkingSpace = function(spaceId) {
            const space = parkingData[spaceId] || {
                id: spaceId,
                block: spaceId.split('-')[0],
                floor: 'Ground',
                status: 'available',
                vehicle: null,
                tenant: null,
                owner: null
            };

            const modal = document.getElementById('parking-edit-modal');
            const form = document.getElementById('parking-edit-form');
            if (!modal || !form) return;

            form.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Parking Space</label>
                        <input type="text" value="${space.id}" disabled style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Status</label>
                        <select id="parking-status" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="available" ${space.status === 'available' ? 'selected' : ''}>Available</option>
                            <option value="occupied" ${space.status === 'occupied' ? 'selected' : ''}>Occupied</option>
                            <option value="visitor" ${space.status === 'visitor' ? 'selected' : ''}>Visitor</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Vehicle Number</label>
                        <input type="text" id="parking-vehicle" value="${space.vehicle || ''}" placeholder="e.g., KCA 123A" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Apartment/Tenant</label>
                        <input type="text" id="parking-tenant" value="${space.tenant || ''}" placeholder="e.g., A101" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Owner Name</label>
                        <input type="text" id="parking-owner" value="${space.owner || ''}" placeholder="e.g., John Doe" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="saveParkingSpace('${spaceId}')" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fa-solid fa-save"></i> Save
                        </button>
                        <button onclick="closeParkingEditModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        };

        window.saveParkingSpace = function(spaceId) {
            const status = document.getElementById('parking-status').value;
            const vehicle = document.getElementById('parking-vehicle').value.trim();
            const tenant = document.getElementById('parking-tenant').value.trim();
            const owner = document.getElementById('parking-owner').value.trim();

            const update = {
                status: status,
                vehicle: vehicle || null,
                tenant: tenant || null,
                owner: owner || null,
                updatedAt: new Date().toISOString(),
                updatedBy: auth.currentUser ? auth.currentUser.email : 'Security'
            };

            database.ref(`parkingSpaces/${spaceId}`).update(update)
                .then(() => {
                    parkingData[spaceId] = { ...parkingData[spaceId], ...update };
                    closeParkingEditModal();
                    renderParkingMap(currentParkingBlock);
                    alert('Parking space updated successfully!');
                })
                .catch(error => {
                    alert('Error updating parking space: ' + error.message);
                });
        };

        window.closeParkingEditModal = function() {
            const modal = document.getElementById('parking-edit-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('parking-edit-modal');
            if (modal && e.target === modal) {
                closeParkingEditModal();
            }
        });

        // Gate Visitor Form
        function initializeGateVisitorForm() {
            const form = document.getElementById('gate-visitor-form');
            const carRegInput = document.getElementById('gate-car-reg');
            const parkingAssignment = document.getElementById('gate-parking-assignment');
            const parkingSlotSelect = document.getElementById('gate-parking-slot');
            const idFrontInput = document.getElementById('gate-id-front');
            const idBackInput = document.getElementById('gate-id-back');
            const idFrontPreview = document.getElementById('gate-id-front-preview');
            const idBackPreview = document.getElementById('gate-id-back-preview');
            const idFrontImg = document.getElementById('gate-id-front-img');
            const idBackImg = document.getElementById('gate-id-back-img');

            // Show parking assignment if car reg is provided
            if (carRegInput) {
                carRegInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        parkingAssignment.style.display = 'block';
                        loadAvailableParkingSlots();
                    } else {
                        parkingAssignment.style.display = 'none';
                        parkingSlotSelect.value = '';
                    }
                });
            }

            // Preview ID images
            if (idFrontInput) {
                idFrontInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            idFrontImg.src = e.target.result;
                            idFrontPreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (idBackInput) {
                idBackInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            idBackImg.src = e.target.result;
                            idBackPreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Form submission
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const visitorName = document.getElementById('gate-visitor-name').value.trim();
                    const visitorPhone = document.getElementById('gate-visitor-phone').value.trim();
                    const hostName = document.getElementById('gate-host-name').value.trim();
                    const houseNumber = document.getElementById('gate-house-number').value.trim();
                    const carReg = document.getElementById('gate-car-reg').value.trim();
                    const parkingSlot = document.getElementById('gate-parking-slot').value;
                    const idFrontFile = idFrontInput.files[0];
                    const idBackFile = idBackInput.files[0];

                    if (!visitorName || !visitorPhone || !hostName || !houseNumber || !idFrontFile || !idBackFile) {
                        alert('Please fill in all required fields and upload both ID photos.');
                        return;
                    }

                    // Convert images to base64
                    const convertToBase64 = (file) => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                    };

                    try {
                        const idFrontBase64 = await convertToBase64(idFrontFile);
                        const idBackBase64 = await convertToBase64(idBackFile);

                        // Find tenant by house number
                        const tenantsRef = database.ref('tenants');
                        const tenantsSnapshot = await tenantsRef.once('value');
                        let tenantId = null;
                        let tenantEmail = null;
                        let tenantName = null;

                        tenantsSnapshot.forEach((child) => {
                            const tenant = child.val();
                            const tenantHouseNumber = tenant.houseNumber || tenant.info?.houseNumber || tenant.info?.house;
                            if (tenantHouseNumber === houseNumber) {
                                tenantId = child.key;
                                tenantEmail = tenant.email || tenant.info?.email || tenant.auth?.email || '';
                                tenantName = tenant.name || tenant.info?.fullName || tenant.info?.name || hostName;
                            }
                        });

                        if (!tenantId) {
                            alert('House number not found. Please select a valid house number from the list.');
                            return;
                        }

                        // Ensure tenantEmail is not undefined
                        if (!tenantEmail) {
                            console.warn('Tenant email not found for house number:', houseNumber);
                            tenantEmail = ''; // Use empty string instead of undefined
                        }

                        // Create visitor request - status is 'pending-verification' until tenant verifies
                        const visitorRequest = {
                            visitorName: visitorName,
                            visitorContact: visitorPhone,
                            tenantName: tenantName || hostName,
                            tenantId: tenantId,
                            roomNumber: houseNumber,
                            apartment: houseNumber,
                            carPlate: carReg || null,
                            idPhoto: idFrontBase64,
                            idPhotoBack: idBackBase64,
                            status: 'pending-verification',
                            visitDate: new Date().toISOString().split('T')[0],
                            visitTime: new Date().toTimeString().split(' ')[0].substring(0, 5),
                            registeredAt: new Date().toISOString(),
                            registeredBy: auth.currentUser ? auth.currentUser.email : 'Security',
                            numberOfVisitors: 1
                        };

                        // Only add tenantEmail if it exists (Firebase doesn't allow undefined values)
                        if (tenantEmail) {
                            visitorRequest.tenantEmail = tenantEmail;
                        }

                        // Save visitor request
                        const visitorRef = database.ref('visitorRequests').push(visitorRequest);
                        const visitorId = visitorRef.key;

                        // Assign parking if car is provided
                        if (carReg && parkingSlot) {
                            const parkingUpdate = {
                                status: 'visitor',
                                vehicle: carReg,
                                owner: visitorName,
                                tenant: houseNumber,
                                visitorId: visitorId,
                                assignedAt: new Date().toISOString(),
                                assignedBy: auth.currentUser ? auth.currentUser.email : 'Security'
                            };
                            await database.ref(`parkingSpaces/${parkingSlot}`).update(parkingUpdate);
                        }

                        // Notify tenant to verify visitor
                        if (window.createNotification && tenantId) {
                            window.createNotification(database, tenantId, {
                                type: 'visitor',
                                title: 'Visitor Arrived - Verification Required',
                                message: `${visitorName} has arrived at the gate. Please verify this visitor in your portal.`,
                                link: '#visitors'
                            }).catch(err => console.error('Notification error:', err));
                        }

                        // Also create a direct notification entry in notifications node
                        if (tenantId) {
                            database.ref(`notifications/${tenantId}`).push({
                                type: 'visitor',
                                title: 'Visitor Arrived - Verification Required',
                                message: `${visitorName} has arrived at the gate. Please verify this visitor.`,
                                link: '#visitors',
                                read: false,
                                createdAt: new Date().toISOString()
                            }).catch(err => console.error('Direct notification error:', err));
                        }

                        alert('Visitor registered successfully! Notification sent to tenant. Waiting for tenant verification before check-in.');
                        form.reset();
                        idFrontPreview.style.display = 'none';
                        idBackPreview.style.display = 'none';
                        parkingAssignment.style.display = 'none';
                        
                        // Force refresh visitor list
                        setTimeout(() => {
                            database.ref('visitorRequests').once('value').then(snapshot => {
                                const requests = [];
                                if (snapshot.exists()) {
                                    snapshot.forEach((child) => {
                                        const data = child.val();
                                        if (data) {
                                            requests.push({ id: child.key, ...data });
                                        }
                                    });
                                }
                                renderVisitorData(requests);
                            });
                        }, 500);

                    } catch (error) {
                        console.error('Error checking in visitor:', error);
                        alert('Error checking in visitor: ' + error.message);
                    }
                });
            }
        }

        // Load visitor requests for management table
        function loadVisitorRequestsTable() {
            const container = document.getElementById('visitorRequestsList');
            if (!container) return;
            
            database.ref('visitorRequests').orderByChild('createdAt').on('value', (snapshot) => {
                const requests = snapshot.val() || {};
                if (Object.keys(requests).length === 0) {
                    container.innerHTML = '<p style="color: #666; padding: 15px;">No visitor requests yet.</p>';
                    return;
                }
                
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><th style="padding: 12px; text-align: left; font-weight: 600;">Visitor</th><th style="padding: 12px; text-align: left; font-weight: 600;">Tenant</th><th style="padding: 12px; text-align: left; font-weight: 600;">Visit Date</th><th style="padding: 12px; text-align: left; font-weight: 600;">Time</th><th style="padding: 12px; text-align: left; font-weight: 600;">Status</th><th style="padding: 12px; text-align: left; font-weight: 600;">Security Code</th><th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th></tr></thead><tbody>';
                
                Object.entries(requests).reverse().forEach(([key, request]) => {
                    const status = request.status || 'pending';
                    const visitDate = request.visitDate || '-';
                    const visitTime = request.visitTime || '-';
                    
                    // Determine status badge color
                    let statusBadge = '';
                    if (status === 'pending-verification') {
                        statusBadge = '<span style="background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Pending Verification</span>';
                    } else if (status === 'checked-in' && !request.checkedInAt) {
                        statusBadge = '<span style="background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Approved</span>';
                    } else if (status === 'checked-in' && request.checkedInAt) {
                        statusBadge = '<span style="background: #cce5ff; color: #004085; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Checked In</span>';
                    } else if (status === 'rejected') {
                        statusBadge = '<span style="background: #f8d7da; color: #721c24; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Rejected</span>';
                    } else if (status === 'registered') {
                        statusBadge = '<span style="background: #d1ecf1; color: #0c5460; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Registered</span>';
                    } else if (status === 'checked-out') {
                        statusBadge = '<span style="background: #e2e3e5; color: #383d41; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Checked Out</span>';
                    } else {
                        statusBadge = `<span style="background: #e9ecef; color: #495057; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">${status}</span>`;
                    }
                    
                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 12px;">
                                <strong>${request.visitorName || 'N/A'}</strong><br>
                                <small style="color: #666;">${request.visitorContact || ''}</small>
                                ${request.carPlate ? `<br><small style="color:#999;"><i class="fa-solid fa-car-side"></i> ${request.carPlate}</small>` : ''}
                            </td>
                            <td style="padding: 12px;">${request.tenantName || 'Tenant'}<br><small style="color: #666;">${request.tenantEmail || ''}</small><br><small style="color: #999;">${request.roomNumber || ''}</small></td>
                            <td style="padding: 12px;">${visitDate}</td>
                            <td style="padding: 12px;">${visitTime}</td>
                            <td style="padding: 12px;">${statusBadge}</td>
                            <td style="padding: 12px;"><strong>${request.securityCode || '-'}</strong></td>
                            <td style="padding: 12px;">
                                ${status === 'pending-verification' ? `
                                    <button class="btn btn-sm" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px; font-weight: 600;" onclick="securityApproveVisitor('${key}')">
                                        <i class="fa-solid fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-sm" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px; font-weight: 600;" onclick="securityRejectVisitor('${key}')">
                                        <i class="fa-solid fa-times"></i> Reject
                                    </button>
                                ` : ''}
                                ${status === 'checked-in' && !request.checkedInAt ? `
                                    <span style="color: #28a745; font-size: 12px; font-weight: 600;"><i class="fa-solid fa-check-circle"></i> Approved</span>
                                ` : ''}
                                ${status === 'rejected' ? `
                                    <span style="color: #dc3545; font-size: 12px; font-weight: 600;"><i class="fa-solid fa-times-circle"></i> Rejected</span>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }, (error) => {
                container.innerHTML = '<p style="color: #dc3545; padding: 15px;">Error loading visitor requests: ' + error.message + '</p>';
            });
        }

        // Security approve visitor (overrides tenant verification if needed)
        window.securityApproveVisitor = function(requestId) {
            if (!confirm('Approve this visitor? They will be allowed entry.')) return;
            
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    
                    const updates = {
                        status: 'checked-in', // Approved - ready for check-in
                        approvedBy: auth.currentUser ? auth.currentUser.email : 'Security',
                        approvedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    return database.ref(`visitorRequests/${requestId}`).update(updates).then(() => {
                        // Notify tenant
                        if (window.createNotification && request.tenantId) {
                            window.createNotification(database, request.tenantId, {
                                type: 'visitor',
                                title: 'Visitor Approved',
                                message: `${request.visitorName || 'Visitor'} has been approved by security.`,
                                link: '#visitors'
                            });
                        }
                    });
                })
                .then(() => {
                    alert('Visitor approved successfully!');
                })
                .catch((error) => {
                    alert('Error approving visitor: ' + error.message);
                });
        };

        // Security reject visitor
        window.securityRejectVisitor = function(requestId) {
            if (!confirm('Reject this visitor? They will not be allowed entry.')) return;
            
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    
                    const updates = {
                        status: 'rejected',
                        rejectedBy: auth.currentUser ? auth.currentUser.email : 'Security',
                        rejectedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    return database.ref(`visitorRequests/${requestId}`).update(updates).then(() => {
                        // Notify tenant
                        if (window.createNotification && request.tenantId) {
                            window.createNotification(database, request.tenantId, {
                                type: 'visitor',
                                title: 'Visitor Rejected',
                                message: `${request.visitorName || 'Visitor'} was rejected by security.`,
                                link: '#visitors'
                            });
                        }
                    });
                })
                .then(() => {
                    alert('Visitor rejected successfully!');
                })
                .catch((error) => {
                    alert('Error rejecting visitor: ' + error.message);
                });
        };

        function loadHouseNumbers() {
            const houseNumberSelect = document.getElementById('gate-house-number');
            const hostNameSelect = document.getElementById('gate-host-name');
            if (!houseNumberSelect) return;

            database.ref('tenants').once('value').then(snapshot => {
                const houseNumbers = [];
                const hostNames = [];
                snapshot.forEach((child) => {
                    const tenant = child.val();
                    const houseNumber = tenant.houseNumber || tenant.info?.houseNumber || tenant.info?.house;
                    const tenantName = tenant.name || tenant.info?.fullName || tenant.info?.name || 'Unknown';
                    
                    if (houseNumber && !houseNumbers.find(h => h.number === houseNumber)) {
                        houseNumbers.push({
                            number: houseNumber,
                            name: tenantName
                        });
                    }
                    
                    // Add to host names list
                    if (tenantName && tenantName !== 'Unknown') {
                        hostNames.push({
                            name: tenantName,
                            houseNumber: houseNumber
                        });
                    }
                });

                // Sort house numbers
                houseNumbers.sort((a, b) => {
                    // Sort by block first (A, B, C), then by number
                    const blockA = a.number.charAt(0);
                    const blockB = b.number.charAt(0);
                    if (blockA !== blockB) {
                        return blockA.localeCompare(blockB);
                    }
                    const numA = parseInt(a.number.substring(1)) || 0;
                    const numB = parseInt(b.number.substring(1)) || 0;
                    return numA - numB;
                });

                // Populate house number dropdown
                houseNumberSelect.innerHTML = '<option value="">Select house number...</option>';
                houseNumbers.forEach(house => {
                    const option = document.createElement('option');
                    option.value = house.number;
                    option.textContent = `${house.number} - ${house.name}`;
                    houseNumberSelect.appendChild(option);
                });

                // Populate host name dropdown
                if (hostNameSelect) {
                    hostNames.sort((a, b) => a.name.localeCompare(b.name));
                    hostNameSelect.innerHTML = '<option value="">Select host name...</option>';
                    hostNames.forEach(host => {
                        const option = document.createElement('option');
                        option.value = host.name;
                        option.textContent = `${host.name} (${host.houseNumber || 'N/A'})`;
                        option.dataset.houseNumber = host.houseNumber || '';
                        hostNameSelect.appendChild(option);
                    });
                    
                    // Auto-fill house number when host is selected
                    hostNameSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption.dataset.houseNumber && houseNumberSelect) {
                            houseNumberSelect.value = selectedOption.dataset.houseNumber;
                        }
                    });
                }
            });
        }

        function loadAvailableParkingSlots() {
            const parkingSlotSelect = document.getElementById('gate-parking-slot');
            if (!parkingSlotSelect) return;

            database.ref('parkingSpaces').once('value').then(snapshot => {
                const spaces = [];
                snapshot.forEach((child) => {
                    const space = child.val();
                    if (space.status === 'available' || space.status === 'visitor') {
                        spaces.push({
                            id: child.key,
                            ...space
                        });
                    }
                });

                parkingSlotSelect.innerHTML = '<option value="">Select parking slot...</option>';
                spaces.forEach(space => {
                    const option = document.createElement('option');
                    option.value = space.id;
                    option.textContent = `${space.id} - ${space.status === 'available' ? 'Available' : 'Visitor'}`;
                    parkingSlotSelect.appendChild(option);
                });
            });
        }

        // QR Scanner code removed - using manual visitor check-in instead
    </script>
</body>

</html>

