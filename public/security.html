<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mweshpra Apartments - Security Portal</title>
    <link href="bootstrap.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="js/notifications.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        .security-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }
        .auth-card, .security-app {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            position: relative;
            z-index: 1;
        }
        .auth-card {
            max-width: 480px;
            margin: 0 auto;
            animation: slideUp 0.6s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .auth-card-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-card-header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .auth-card-header p {
            color: #666;
            font-size: 14px;
        }
        .account-type-selector {
            display: flex;
            background: #f5f6fa;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 30px;
            gap: 5px;
        }
        .account-type-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .account-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .account-type-btn:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 14px 18px;
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin-top: 10px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .login-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .login-message.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        .login-message.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }
        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: #e9ecef;
        }
        .divider span {
            background: white;
            padding: 0 15px;
            position: relative;
            color: #999;
            font-size: 13px;
        }
        .switch-account-link {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .switch-account-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: color 0.3s ease;
        }
        .switch-account-link a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        .security-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }
        .stat-card h3 {
            margin: 0;
            font-size: 32px;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .dashboard-section {
            background: white;
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #f0f0f0;
        }
        .dashboard-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .visitor-row {
            border-bottom: 1px solid #f1f1f1;
            padding: 12px 0;
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .visitor-row:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }
        .visitor-row:last-child {
            border-bottom: none;
        }
        .visitor-details-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .visitor-details-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .parking-map-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        .parking-map-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .parking-legend {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .parking-block-selector {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .parking-block-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .parking-block-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .parking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .parking-space {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .parking-space::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .parking-space:hover::before {
            left: 100%;
        }
        .parking-space:hover {
            transform: scale(1.1) rotate(2deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .parking-space.available {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        .parking-space.occupied {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .parking-space.visitor {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .parking-space-number {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .parking-space-status {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.9;
        }
        .parking-details-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            text-transform: capitalize;
        }
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.rejected, .status-badge.cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .status-badge.checked-in {
            background: #cce5ff;
            color: #004085;
        }
        .status-badge.checked-out {
            background: #e2e3e5;
            color: #383d41;
        }
        .status-badge.registered {
            background: #d1ecf1;
            color: #0c5460;
        }
        #id-capture-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content-capture {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        #id-capture-video, #id-capture-canvas {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .capture-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .visitor-media {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        .visitor-media img {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #f0f0f0;
        }
        #qr-reader {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
        }
        .qr-result-card {
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            background: #fdfdfd;
        }
        .qr-result-card h4 {
            margin-bottom: 12px;
        }
        .table-header {
            font-weight: 600;
            color: #666;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 1fr 1fr;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-outline-primary {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
        }
        .btn-outline-secondary {
            background: transparent;
            border: 2px solid #6c757d;
            color: #6c757d;
        }
        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }
        @media(max-width: 900px) {
            .visitor-row, .table-header {
                grid-template-columns: 1fr;
            }
        }
        @media(max-width: 600px) {
            .auth-card {
                padding: 30px 20px;
                margin: 20px;
            }
            .auth-card-header h1 {
                font-size: 24px;
            }
            .account-type-btn {
                padding: 10px 15px;
                font-size: 13px;
            }
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="security-container">
        <div class="auth-card" id="security-login-card">
            <div class="auth-card-header">
                <h1><i class="fa-solid fa-building"></i> Mweshpra Apartments</h1>
                <p>Welcome back! Please sign in to continue</p>
            </div>
            <div class="account-type-selector">
                <button type="button" class="account-type-btn" id="tenant-account-btn" onclick="switchAccountType('tenant')">
                    <i class="fa-solid fa-user"></i> Tenant Account
                </button>
                <button type="button" class="account-type-btn active" id="security-account-btn" onclick="switchAccountType('security')">
                    <i class="fa-solid fa-shield-halved"></i> Security Account
                </button>
            </div>
            <form id="security-login-form">
                <div class="form-group">
                    <label for="securityEmail"><i class="fa-solid fa-envelope"></i> Email Address</label>
                    <input type="email" id="securityEmail" class="form-control" placeholder="Enter your email address" required>
                </div>
                <div class="form-group">
                    <label for="securityPassword"><i class="fa-solid fa-lock"></i> Password</label>
                    <input type="password" id="securityPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-right-to-bracket"></i> Sign In
                </button>
            </form>
            <div id="security-login-message" class="login-message"></div>
            <div class="switch-account-link" id="switch-account-section" style="display: none;">
                <a href="login.html">
                    <i class="fa-solid fa-arrow-left"></i> Switch to Tenant Login
                </a>
            </div>
        </div>

        <div class="security-app" id="security-app" style="display: none;">
            <div class="security-header">
                <div>
                    <h2><i class="fa-solid fa-shield"></i> Security Control Center</h2>
                    <p class="text-muted" id="security-user-email"></p>
                </div>
                <div>
                    <button class="btn btn-secondary" id="security-logout-btn">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" id="pending-count-card">
                    <p><i class="fa-solid fa-users"></i> Active Visitors</p>
                    <h3 id="pending-count">0</h3>
                    <small style="opacity: 0.8; font-size: 12px;">On premises now</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);">
                    <p><i class="fa-solid fa-calendar-day"></i> Today's Visitors</p>
                    <h3 id="today-count">0</h3>
                    <small style="opacity: 0.8; font-size: 12px;">Visited today</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);">
                    <p><i class="fa-solid fa-door-open"></i> Currently Checked In</p>
                    <h3 id="checked-in-count">0</h3>
                    <small style="opacity: 0.8; font-size: 12px;">People count</small>
                </div>
            </div>

            <div class="dashboard-section">
                <h3><i class="fa-solid fa-list-check"></i> Active Visitors (Registered & Checked-In)</h3>
                <p class="text-muted" style="margin-bottom: 15px;">Visitors currently on premises - click on any visitor to view full details</p>
                <div class="table-header">
                    <div>Visitor</div>
                    <div>Tenant / Room</div>
                    <div>Visit</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
                <div id="pending-requests"></div>
            </div>

            <div class="dashboard-section">
                <h3><i class="fa-solid fa-clock-rotate-left"></i> Visitor History</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px;">Filter by Date:</label>
                        <input type="date" id="history-date-filter" class="form-control" style="max-width: 200px;">
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-secondary" onclick="clearHistoryFilter()" style="padding: 10px 20px;">
                            <i class="fa-solid fa-times"></i> Clear Filter
                        </button>
                    </div>
                </div>
                <div class="table-header">
                    <div>Visitor</div>
                    <div>Tenant / Room</div>
                    <div>Visit</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
                <div id="visitor-history"></div>
            </div>

            <!-- Register New Visitor Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-user-plus"></i> Register New Visitor at Gate</h3>
                <p class="text-muted" style="margin-bottom: 20px;">Fill in visitor details when they arrive at the gate</p>
                <form id="gate-visitor-form" style="display: grid; gap: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Visitor Name *</label>
                            <input type="text" id="gate-visitor-name" class="form-control" placeholder="Enter visitor name" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Visitor Phone *</label>
                            <input type="tel" id="gate-visitor-phone" class="form-control" placeholder="Enter phone number" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Host Name *</label>
                            <input type="text" id="gate-host-name" class="form-control" placeholder="Enter host name" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">House Number *</label>
                            <select id="gate-house-number" class="form-control" required>
                                <option value="">Select house number...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Car Registration (Optional)</label>
                            <input type="text" id="gate-car-reg" class="form-control" placeholder="Enter car registration">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Parking Slot (if car provided)</label>
                            <select id="gate-parking-slot" class="form-control">
                                <option value="">Select parking slot...</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ID Photo (Front) *</label>
                        <input type="file" id="gate-id-front" accept="image/*" required>
                        <div id="gate-id-front-preview" style="margin-top: 10px;"></div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ID Photo (Back) *</label>
                        <input type="file" id="gate-id-back" accept="image/*" required>
                        <div id="gate-id-back-preview" style="margin-top: 10px;"></div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="max-width: 300px;">
                        <i class="fa-solid fa-check"></i> Register Visitor
                    </button>
                </form>
            </div>

            <!-- Parking Map Section -->
            <div class="dashboard-section">
                <h3><i class="fa-solid fa-map-location-dot"></i> Parking Map Management</h3>
                <p class="text-muted" style="margin-bottom: 20px;">View and manage parking spaces - click on any space to update details</p>
                <div id="parking-map-section"></div>
            </div>
        </div>
    </div>

    <!-- ID Capture Modal -->
    <div id="id-capture-modal">
        <div class="modal-content-capture"></div>
    </div>

    <!-- Visitor Details Modal -->
    <div id="visitor-details-modal" class="visitor-details-modal">
        <div class="visitor-details-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #333; margin: 0;"><i class="fa-solid fa-user"></i> Visitor Details</h3>
                <button onclick="closeVisitorDetailsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div id="visitor-details-content">
                <!-- Details will be shown here -->
            </div>
        </div>
    </div>

    <!-- Parking Details Modal -->
    <div id="parking-details-modal" class="parking-details-modal">
        <div class="visitor-details-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #333; margin: 0;"><i class="fa-solid fa-car"></i> Parking Space Details</h3>
                <button onclick="closeParkingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div id="parking-details-content">
                <!-- Details will be shown here -->
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCk7rNj_35-C8zrQB0O2S4c9CORNIsqlxQ",
            authDomain: "mweshpra-apartments.firebaseapp.com",
            projectId: "mweshpra-apartments",
            storageBucket: "mweshpra-apartments.firebasestorage.app",
            messagingSenderId: "8486695233",
            appId: "1:8486695233:web:fa68793732171d5bfb71c0",
            measurementId: "G-1FM5TXCL1C",
            databaseURL: "https://mweshpra-apartments-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const securityEmails = [
            "Preston.mwendwa@riarauniversity.ac.ke",
            "guard@mweshpra.com"
        ];

        let visitorRefListener = null;

        const loginCard = document.getElementById('security-login-card');
        const appShell = document.getElementById('security-app');
        const loginForm = document.getElementById('security-login-form');
        const loginMessage = document.getElementById('security-login-message');
        const pendingContainer = document.getElementById('pending-requests');
        const visitorHistoryContainer = document.getElementById('visitor-history');
        const historyDateFilter = document.getElementById('history-date-filter');
        const userEmailEl = document.getElementById('security-user-email');
        let allVisitorsData = [];
        const pendingCountEl = document.getElementById('pending-count');
        const todayCountEl = document.getElementById('today-count');
        const checkedInCountEl = document.getElementById('checked-in-count');
        const tenantBtn = document.getElementById('tenant-account-btn');
        const securityBtn = document.getElementById('security-account-btn');
        const switchAccountSection = document.getElementById('switch-account-section');
        let currentAccountType = 'security';

        window.switchAccountType = function(type) {
            currentAccountType = type;
            if (type === 'tenant') {
                window.location.href = 'login.html';
                return;
            } else {
                tenantBtn.classList.remove('active');
                securityBtn.classList.add('active');
                switchAccountSection.style.display = 'none';
            }
        };

        function showMessage(message, type) {
            loginMessage.textContent = message;
            loginMessage.className = 'login-message ' + (type || 'error');
            loginMessage.style.display = 'block';
            setTimeout(() => {
                loginMessage.style.display = 'none';
            }, 5000);
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('securityEmail').value.trim().toLowerCase();
            const password = document.getElementById('securityPassword').value;

            if (!email || !password) {
                showMessage('Please fill in all fields.', 'error');
                return;
            }

            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Signing In...';

            auth.signInWithEmailAndPassword(email, password)
                .then((credential) => {
                    const emailLower = email.toLowerCase();
                    const isAuthorized = securityEmails.some(secEmail => secEmail.toLowerCase() === emailLower);
                    if (!isAuthorized) {
                        auth.signOut();
                        throw new Error('This account is not authorized for the security portal.');
                    }

                    loginMessage.style.display = 'none';
                    loginCard.style.display = 'none';
                    appShell.style.display = 'block';
                    userEmailEl.textContent = credential.user.email;
                    attachVisitorsListener();
                    setTimeout(() => {
                        loadHouseNumbers();
                        loadAvailableParkingSlots();
                        initializeGateVisitorForm();
                        loadParkingMap();
                    }, 500);
                })
                .catch((error) => {
                    let errorMessage = 'Login failed. Please try again.';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    showMessage(errorMessage, 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
        });

        document.getElementById('security-logout-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
                detachVisitorsListener();
                auth.signOut().finally(() => {
                    appShell.style.display = 'none';
                    loginCard.style.display = 'block';
                    loginForm.reset();
                    loginMessage.style.display = 'none';
                });
            }
        });

        auth.onAuthStateChanged((user) => {
            if (!user && appShell.style.display !== 'none') {
                appShell.style.display = 'none';
                loginCard.style.display = 'block';
            } else if (user && appShell.style.display === 'none' && loginCard.style.display === 'none') {
                const emailLower = user.email.toLowerCase();
                const isAuthorized = securityEmails.some(secEmail => secEmail.toLowerCase() === emailLower);
                if (isAuthorized) {
                    appShell.style.display = 'block';
                    loginCard.style.display = 'none';
                    userEmailEl.textContent = user.email;
                    attachVisitorsListener();
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            detachVisitorsListener();
        });

        function attachVisitorsListener() {
            detachVisitorsListener();
            visitorRefListener = database.ref('visitorRequests');
            visitorRefListener.on('value', (snapshot) => {
                const requests = [];
                snapshot.forEach((child) => requests.push({ id: child.key, ...child.val() }));
                renderVisitorData(requests);
            });
        }

        function detachVisitorsListener() {
            if (visitorRefListener) {
                visitorRefListener.off();
                visitorRefListener = null;
            }
        }

        function renderVisitorData(requests) {
            allVisitorsData = requests;
            const today = new Date().toISOString().split('T')[0];
            let registeredCount = 0;
            let todayCount = 0;
            let checkedInCount = 0;
            let totalVisitorCount = 0;

            const activeVisitors = [];
            const historyVisitors = [];

            requests.forEach((req) => {
                const status = req.status || 'registered';
                
                if (status === 'registered' || status === 'pending-verification') {
                    registeredCount++;
                }
                if (req.visitDate === today) todayCount++;
                if (status === 'checked-in' && req.checkedInAt && !req.checkedOutAt) {
                    checkedInCount++;
                    totalVisitorCount += (req.numberOfVisitors || 1);
                }

                // Active visitors: registered or checked-in (not checked out)
                if ((status === 'registered' || status === 'pending-verification' || 
                     (status === 'checked-in' && req.checkedInAt && !req.checkedOutAt))) {
                    activeVisitors.push(req);
                } else if (status === 'checked-out' || status === 'cancelled') {
                    historyVisitors.push(req);
                }
            });

            pendingCountEl.textContent = activeVisitors.length;
            todayCountEl.textContent = todayCount;
            checkedInCountEl.textContent = totalVisitorCount;

            pendingContainer.innerHTML = activeVisitors.length ? activeVisitors.map(renderVisitorRow).join('') :
                '<p class="text-muted" style="padding: 15px;">No active visitors.</p>';

            filterAndRenderHistory();
        }

        function filterAndRenderHistory() {
            const filterDate = historyDateFilter ? historyDateFilter.value : '';
            let historyVisitors = allVisitorsData.filter(req => {
                const status = req.status || 'registered';
                return status === 'checked-out' || status === 'cancelled';
            });

            if (filterDate) {
                historyVisitors = historyVisitors.filter(req => req.visitDate === filterDate || req.checkOutDate === filterDate);
            }

            // Sort by date (most recent first)
            historyVisitors.sort((a, b) => {
                const dateA = new Date(a.checkOutDate || a.visitDate || 0);
                const dateB = new Date(b.checkOutDate || b.visitDate || 0);
                return dateB - dateA;
            });

            visitorHistoryContainer.innerHTML = historyVisitors.length ? historyVisitors.map(renderVisitorRow).join('') :
                '<p class="text-muted" style="padding: 15px;">No visitor history found' + (filterDate ? ' for selected date' : '') + '.</p>';
        }

        if (historyDateFilter) {
            historyDateFilter.addEventListener('change', filterAndRenderHistory);
        }

        window.clearHistoryFilter = function() {
            if (historyDateFilter) {
                historyDateFilter.value = '';
                filterAndRenderHistory();
            }
        };

        function renderVisitorRow(request) {
            const visitInfo = `${request.visitDate || '-'} ${request.visitTime || ''}`;
            const status = request.status || 'registered';
            const statusClass = `status-badge ${status}`;
            const carInfo = request.carPlate ? `<div style="color:#777; font-size:12px;"><i class="fa-solid fa-car-side"></i> ${request.carPlate}</div>` : '';
            const visitorCount = request.numberOfVisitors ? `<div style="color:#777; font-size:12px;"><i class="fa-solid fa-users"></i> ${request.numberOfVisitors} visitor(s)</div>` : '';

            const mediaHtml = request.idPhoto ? `
                <div class="visitor-media">
                    <img src="${request.idPhoto}" alt="ID Photo">
                </div>
            ` : '';

            let statusDisplay = '';
            if (status === 'checked-in' && request.checkedInAt && !request.checkedOutAt) {
                statusDisplay = '<span class="status-badge checked-in">Checked In</span>';
            } else if (status === 'checked-out') {
                statusDisplay = '<span class="status-badge checked-out">Checked Out</span>';
            } else if (status === 'registered' || status === 'pending-verification') {
                statusDisplay = '<span class="status-badge registered">Registered</span>';
            } else {
                statusDisplay = `<span class="${statusClass}">${status.replace('-', ' ')}</span>`;
            }

            const requestId = request.id || request.requestId;
            return `
                <div class="visitor-row" onclick="showVisitorDetails('${requestId}')" data-request-id="${requestId}">
                    <div>
                        <strong>${request.visitorName || 'N/A'}</strong>
                        <div style="color:#777; font-size:12px;">${request.visitorContact || ''}</div>
                        ${visitorCount}
                        ${carInfo}
                        <div style="color:#999; font-size:12px;">Code: ${request.securityCode || '-'}</div>
                        ${mediaHtml}
                    </div>
                    <div>
                        <strong>${request.tenantName || 'Tenant'}</strong>
                        <div style="color:#777; font-size:12px;">${request.tenantEmail || ''}</div>
                        ${request.roomNumber ? `<div style="color:#999; font-size:12px;">Room: ${request.roomNumber}</div>` : ''}
                    </div>
                    <div>${visitInfo}</div>
                    <div>${statusDisplay}</div>
                    <div onclick="event.stopPropagation();">
                        ${renderActionButtons(request)}
                    </div>
                </div>
            `;
        }

        window.showVisitorDetails = function(requestId) {
            const request = allVisitorsData.find(r => (r.id || r.requestId) === requestId);
            if (!request) {
                alert('Visitor details not found');
                return;
            }

            const modal = document.getElementById('visitor-details-modal');
            const content = document.getElementById('visitor-details-content');
            
            const checkInTime = request.checkedInAt ? new Date(request.checkedInAt).toLocaleString() : 'Not checked in';
            const checkOutTime = request.checkedOutAt ? new Date(request.checkedOutAt).toLocaleString() : 'Not checked out';
            
            content.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Visitor Name</label>
                            <p style="margin: 0; color: #333;">${request.visitorName || 'N/A'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Phone Number</label>
                            <p style="margin: 0; color: #333;">${request.visitorContact || 'N/A'}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Number of Visitors</label>
                            <p style="margin: 0; color: #333;">${request.numberOfVisitors || 1}</p>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Security Code</label>
                            <p style="margin: 0; color: #333; font-weight: 700; font-size: 18px;">${request.securityCode || 'N/A'}</p>
                        </div>
                    </div>
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px;">
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 10px;">Host Information</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Host Name</label>
                                <p style="margin: 0; color: #333;">${request.tenantName || 'N/A'}</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Email</label>
                                <p style="margin: 0; color: #333;">${request.tenantEmail || 'N/A'}</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">House/Room Number</label>
                                <p style="margin: 0; color: #333;">${request.roomNumber || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px;">
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 10px;">Visit Information</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Visit Date</label>
                                <p style="margin: 0; color: #333;">${request.visitDate || 'N/A'}</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Visit Time</label>
                                <p style="margin: 0; color: #333;">${request.visitTime || 'N/A'}</p>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Status</label>
                                <p style="margin: 0;">${request.status ? `<span class="status-badge ${request.status}">${request.status.replace('-', ' ')}</span>` : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    ${request.carPlate ? `
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px;">
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 10px;">Vehicle Information</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Car Registration</label>
                                <p style="margin: 0; color: #333;">${request.carPlate}</p>
                            </div>
                            ${request.parkingSlot ? `
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Parking Slot</label>
                                <p style="margin: 0; color: #333;">${request.parkingSlot}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px;">
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 10px;">Check-In/Out Information</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Checked In</label>
                                <p style="margin: 0; color: #333;">${checkInTime}</p>
                                ${request.checkedInBy ? `<p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">By: ${request.checkedInBy}</p>` : ''}
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Checked Out</label>
                                <p style="margin: 0; color: #333;">${checkOutTime}</p>
                                ${request.checkedOutBy ? `<p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">By: ${request.checkedOutBy}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    ${request.idPhoto ? `
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px;">
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 10px;">ID Photos</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Front</label>
                                <img src="${request.idPhoto}" style="max-width: 200px; border-radius: 8px; border: 2px solid #667eea;">
                            </div>
                            ${request.idPhotoBack ? `
                            <div>
                                <label style="font-weight: 600; color: #666; display: block; margin-bottom: 5px; font-size: 14px;">Back</label>
                                <img src="${request.idPhotoBack}" style="max-width: 200px; border-radius: 8px; border: 2px solid #667eea;">
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    ${request.reason ? `
                    <div style="border-top: 2px solid #e9ecef; padding-top: 15px;">
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Visit Reason</label>
                        <p style="margin: 0; color: #333;">${request.reason}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.style.display = 'flex';
        };

        window.closeVisitorDetailsModal = function() {
            document.getElementById('visitor-details-modal').style.display = 'none';
        };

        function renderActionButtons(request) {
            const buttons = [];
            const requestKey = request.id || request.requestId;
            if (!requestKey) return '<span style="color:#999; font-size:12px;">No actions</span>';

            const status = request.status || 'registered';

            if (status === 'registered' || status === 'pending-verification' || (status === 'checked-in' && !request.checkedInAt)) {
                buttons.push(`<button class="btn btn-sm btn-success" onclick="securityCheckInVisitor('${requestKey}')" style="margin: 2px;"><i class="fa-solid fa-door-open"></i> Check-In</button>`);
            } else if (status === 'checked-in' && request.checkedInAt && !request.checkedOutAt) {
                buttons.push(`<button class="btn btn-sm btn-secondary" onclick="checkOutVisitor('${requestKey}')" style="margin: 2px;"><i class="fa-solid fa-door-closed"></i> Check-Out</button>`);
            }
            
            buttons.push(`<button class="btn btn-sm btn-danger" onclick="deleteVisitor('${requestKey}')" style="margin: 2px;"><i class="fa-solid fa-trash"></i> Delete</button>`);

            if (buttons.length === 0) {
                return '<span style="color:#999; font-size:12px;">No actions</span>';
            }

            return buttons.join(' ');
        }

        window.securityCheckInVisitor = function(requestId) {
            if (!confirm('Check in this visitor?')) return;
            
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    
                    if (request.checkedInAt && !request.checkedOutAt) {
                        alert('Visitor is already checked in.');
                        return;
                    }
                    
                    const updates = {
                        status: 'checked-in',
                        checkedInAt: new Date().toISOString(),
                        checkedInBy: auth.currentUser ? auth.currentUser.email : 'Security',
                        checkInTime: new Date().toTimeString().split(' ')[0].substring(0, 5),
                        checkInDate: new Date().toISOString().split('T')[0],
                        updatedAt: new Date().toISOString()
                    };
                    
                    return database.ref(`visitorRequests/${requestId}`).update(updates).then(() => {
                        if (window.createNotification && request.tenantId) {
                            window.createNotification(database, request.tenantId, {
                                type: 'visitor',
                                title: 'Visitor Checked In',
                                message: `${request.visitorName || 'Visitor'} has been checked in at ${updates.checkInTime} on ${updates.checkInDate}.`,
                                link: '#visitors'
                            });
                        }
                        alert(`Visitor checked in successfully!\nTime: ${updates.checkInTime}\nDate: ${updates.checkInDate}`);
                    });
                })
                .catch((error) => {
                    alert('Error checking in visitor: ' + error.message);
                });
        };

        window.checkOutVisitor = function(requestId) {
            if (!confirm('Check out this visitor? They will be moved to history.')) return;
            
            database.ref(`visitorRequests/${requestId}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) throw new Error('Visitor request not found');
                    const request = snapshot.val();
                    
                    const now = new Date();
                    const checkOutTime = now.toTimeString().split(' ')[0].substring(0, 5);
                    const checkOutDate = now.toISOString().split('T')[0];
                    const updates = {
                        status: 'checked-out',
                        checkedOutAt: now.toISOString(),
                        checkedOutBy: auth.currentUser ? auth.currentUser.email : 'Security',
                        checkOutTime: checkOutTime,
                        checkOutDate: checkOutDate,
                        updatedAt: now.toISOString()
                    };
                    
                    return database.ref(`visitorRequests/${requestId}`).update(updates).then(() => {
                        if (window.createNotification && request.tenantId) {
                            window.createNotification(database, request.tenantId, {
                                type: 'visitor',
                                title: 'Visitor Checked Out',
                                message: `${request.visitorName || 'Visitor'} has checked out.`,
                                link: '#visitors'
                            });
                        }
                        alert(`Visitor checked out successfully!\nTime: ${checkOutTime}\nDate: ${checkOutDate}\nVisitor has been moved to history.`);
                    });
                })
                .catch((error) => {
                    alert('Error checking out visitor: ' + error.message);
                });
        };

        window.deleteVisitor = function(requestId) {
            if (!confirm('Are you sure you want to delete this visitor record? This action cannot be undone.')) return;
            
            database.ref(`visitorRequests/${requestId}`).remove()
                .then(() => {
                    alert('Visitor record deleted successfully!');
                })
                .catch((error) => {
                    alert('Error deleting visitor: ' + error.message);
                });
        };

        function loadVisitorRequestsTable() {
            const container = document.getElementById('visitorRequestsList');
            if (!container) return;
            
            database.ref('visitorRequests').orderByChild('createdAt').on('value', (snapshot) => {
                const requests = snapshot.val() || {};
                if (Object.keys(requests).length === 0) {
                    container.innerHTML = '<p style="color: #666; padding: 15px;">No visitor requests yet.</p>';
                    return;
                }
                
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><th style="padding: 12px; text-align: left; font-weight: 600;">Visitor</th><th style="padding: 12px; text-align: left; font-weight: 600;">Tenant</th><th style="padding: 12px; text-align: left; font-weight: 600;">Visit Date</th><th style="padding: 12px; text-align: left; font-weight: 600;">Time</th><th style="padding: 12px; text-align: left; font-weight: 600;">Status</th><th style="padding: 12px; text-align: left; font-weight: 600;">Security Code</th><th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th></tr></thead><tbody>';
                
                Object.entries(requests).reverse().forEach(([key, request]) => {
                    const status = request.status || 'registered';
                    const visitDate = request.visitDate || '-';
                    const visitTime = request.visitTime || '-';
                    
                    let statusBadge = '';
                    if (status === 'checked-in' && request.checkedInAt && !request.checkedOutAt) {
                        statusBadge = '<span style="background: #cce5ff; color: #004085; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Checked In</span>';
                    } else if (status === 'checked-out') {
                        statusBadge = '<span style="background: #e2e3e5; color: #383d41; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Checked Out</span>';
                    } else if (status === 'registered' || status === 'pending-verification') {
                        statusBadge = '<span style="background: #d1ecf1; color: #0c5460; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">Registered</span>';
                    } else {
                        statusBadge = `<span style="background: #e9ecef; color: #495057; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">${status}</span>`;
                    }
                    
                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 12px;">
                                <strong>${request.visitorName || 'N/A'}</strong><br>
                                <small style="color: #666;">${request.visitorContact || ''}</small>
                                ${request.carPlate ? `<br><small style="color:#999;"><i class="fa-solid fa-car-side"></i> ${request.carPlate}</small>` : ''}
                            </td>
                            <td style="padding: 12px;">${request.tenantName || 'Tenant'}<br><small style="color: #666;">${request.tenantEmail || ''}</small><br><small style="color: #999;">${request.roomNumber || ''}</small></td>
                            <td style="padding: 12px;">${visitDate}</td>
                            <td style="padding: 12px;">${visitTime}</td>
                            <td style="padding: 12px;">${statusBadge}</td>
                            <td style="padding: 12px;"><strong>${request.securityCode || '-'}</strong></td>
                            <td style="padding: 12px;">
                                ${(status === 'registered' || status === 'pending-verification' || (status === 'checked-in' && !request.checkedInAt)) ? `
                                    <button class="btn btn-sm" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px; font-weight: 600;" onclick="securityCheckInVisitor('${key}')">
                                        <i class="fa-solid fa-door-open"></i> Check-In
                                    </button>
                                ` : ''}
                                ${status === 'checked-in' && request.checkedInAt && !request.checkedOutAt ? `
                                    <button class="btn btn-sm" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px; font-weight: 600;" onclick="checkOutVisitor('${key}')">
                                        <i class="fa-solid fa-door-closed"></i> Check-Out
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin: 2px; font-weight: 600;" onclick="deleteVisitor('${key}')">
                                    <i class="fa-solid fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }, (error) => {
                container.innerHTML = '<p style="color: #dc3545; padding: 15px;">Error loading visitor requests: ' + error.message + '</p>';
            });
        }

        function loadHouseNumbers() {
            const houseNumberSelect = document.getElementById('gate-house-number');
            const hostNameInput = document.getElementById('gate-host-name');
            if (!houseNumberSelect) return;

            database.ref('tenants').once('value').then(snapshot => {
                const houseNumbers = [];
                snapshot.forEach((child) => {
                    const tenant = child.val();
                    const houseNumber = tenant.houseNumber || tenant.info?.houseNumber || tenant.info?.house;
                    const tenantName = tenant.name || tenant.info?.fullName || tenant.info?.name || 'Unknown';
                    
                    if (houseNumber && !houseNumbers.find(h => h.number === houseNumber)) {
                        houseNumbers.push({
                            number: houseNumber,
                            name: tenantName
                        });
                    }
                });

                houseNumbers.sort((a, b) => {
                    const blockA = a.number.charAt(0);
                    const blockB = b.number.charAt(0);
                    if (blockA !== blockB) {
                        return blockA.localeCompare(blockB);
                    }
                    const numA = parseInt(a.number.substring(1)) || 0;
                    const numB = parseInt(b.number.substring(1)) || 0;
                    return numA - numB;
                });

                houseNumberSelect.innerHTML = '<option value="">Select house number...</option>';
                houseNumbers.forEach(house => {
                    const option = document.createElement('option');
                    option.value = house.number;
                    option.textContent = `${house.number} - ${house.name}`;
                    houseNumberSelect.appendChild(option);
                });

                if (houseNumberSelect && hostNameInput) {
                    houseNumberSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption.value && selectedOption.textContent) {
                            const nameMatch = selectedOption.textContent.match(/-\s*(.+)$/);
                            if (nameMatch && hostNameInput) {
                                hostNameInput.value = nameMatch[1].trim();
                            }
                        }
                    });
                }
            });
        }

        function loadAvailableParkingSlots() {
            const parkingSlotSelect = document.getElementById('gate-parking-slot');
            if (!parkingSlotSelect) return;

            database.ref('parkingSpaces').once('value').then(snapshot => {
                const spaces = [];
                snapshot.forEach((child) => {
                    const space = child.val();
                    if (space.status === 'available' || space.status === 'visitor') {
                        spaces.push({
                            id: child.key,
                            ...space
                        });
                    }
                });

                parkingSlotSelect.innerHTML = '<option value="">Select parking slot...</option>';
                spaces.forEach(space => {
                    const option = document.createElement('option');
                    option.value = space.id;
                    option.textContent = `${space.id} - ${space.status === 'available' ? 'Available' : 'Visitor'}`;
                    parkingSlotSelect.appendChild(option);
                });
            });
        }

        function initializeGateVisitorForm() {
            const form = document.getElementById('gate-visitor-form');
            const carRegInput = document.getElementById('gate-car-reg');
            const parkingSlotSelect = document.getElementById('gate-parking-slot');

            if (carRegInput && parkingSlotSelect) {
                carRegInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        parkingSlotSelect.style.display = 'block';
                        loadAvailableParkingSlots();
                    } else {
                        parkingSlotSelect.style.display = 'none';
                        parkingSlotSelect.value = '';
                    }
                });
            }

            const idFrontInput = document.getElementById('gate-id-front');
            const idBackInput = document.getElementById('gate-id-back');
            const idFrontPreview = document.getElementById('gate-id-front-preview');
            const idBackPreview = document.getElementById('gate-id-back-preview');

            if (idFrontInput && idFrontPreview) {
                idFrontInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            idFrontPreview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; border-radius: 8px; border: 2px solid #667eea;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (idBackInput && idBackPreview) {
                idBackInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            idBackPreview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px; border-radius: 8px; border: 2px solid #667eea;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const visitorName = document.getElementById('gate-visitor-name').value.trim();
                    const visitorPhone = document.getElementById('gate-visitor-phone').value.trim();
                    const hostName = document.getElementById('gate-host-name').value.trim();
                    const houseNumber = document.getElementById('gate-house-number').value.trim();
                    const carReg = document.getElementById('gate-car-reg').value.trim();
                    const parkingSlot = document.getElementById('gate-parking-slot').value.trim();
                    const idFrontFile = document.getElementById('gate-id-front').files[0];
                    const idBackFile = document.getElementById('gate-id-back').files[0];

                    if (!visitorName || !visitorPhone || !hostName || !houseNumber || !idFrontFile || !idBackFile) {
                        alert('Please fill in all required fields.');
                        return;
                    }

                    const reader1 = new FileReader();
                    const reader2 = new FileReader();
                    let idFrontBase64 = null;
                    let idBackBase64 = null;
                    let filesRead = 0;

                    reader1.onload = function(e) {
                        idFrontBase64 = e.target.result;
                        filesRead++;
                        if (filesRead === 2) submitVisitorRegistration();
                    };
                    reader2.onload = function(e) {
                        idBackBase64 = e.target.result;
                        filesRead++;
                        if (filesRead === 2) submitVisitorRegistration();
                    };

                    reader1.readAsDataURL(idFrontFile);
                    reader2.readAsDataURL(idBackFile);

                    function submitVisitorRegistration() {
                        database.ref('tenants').once('value').then(tenantSnapshot => {
                            let tenantId = null;
                            let tenantEmail = '';
                            let tenantName = hostName;

                            tenantSnapshot.forEach((child) => {
                                const tenant = child.val();
                                const tenantHouseNumber = tenant.houseNumber || tenant.info?.houseNumber || tenant.info?.house;
                                if (tenantHouseNumber === houseNumber) {
                                    tenantId = child.key;
                                    tenantEmail = tenant.email || tenant.info?.email || tenant.auth?.email || '';
                                    tenantName = tenant.name || tenant.info?.fullName || tenant.info?.name || hostName;
                                }
                            });

                            const securityCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                            const visitorData = {
                                visitorName: visitorName,
                                visitorContact: visitorPhone,
                                tenantName: tenantName,
                                tenantEmail: tenantEmail || '',
                                tenantId: tenantId || '',
                                roomNumber: houseNumber,
                                apartment: houseNumber,
                                carPlate: carReg || null,
                                idPhoto: idFrontBase64,
                                idPhotoBack: idBackBase64,
                                status: 'registered',
                                visitDate: new Date().toISOString().split('T')[0],
                                visitTime: new Date().toTimeString().split(' ')[0].substring(0, 5),
                                registeredAt: new Date().toISOString(),
                                registeredBy: auth.currentUser ? auth.currentUser.email : 'Security',
                                numberOfVisitors: 1,
                                securityCode: securityCode,
                                createdAt: new Date().toISOString()
                            };

                            if (parkingSlot && carReg) {
                                visitorData.parkingSlot = parkingSlot;
                                database.ref(`parkingSpaces/${parkingSlot}`).update({
                                    status: 'visitor',
                                    vehicle: carReg,
                                    visitorId: null,
                                    updatedAt: new Date().toISOString()
                                });
                            }

                            database.ref('visitorRequests').push(visitorData)
                                .then(() => {
                                    alert('Visitor registered successfully!');
                                    form.reset();
                                    if (idFrontPreview) idFrontPreview.innerHTML = '';
                                    if (idBackPreview) idBackPreview.innerHTML = '';
                                    if (parkingSlotSelect) parkingSlotSelect.style.display = 'none';
                                })
                                .catch((error) => {
                                    alert('Error registering visitor: ' + error.message);
                                });
                        });
                    }
                });
            }
        }

        // Parking Map Functions
        let parkingData = {};
        let currentParkingBlock = 'A';

        function loadParkingMap() {
            const container = document.getElementById('parking-map-section');
            if (!container) return;

            container.innerHTML = `
                <div class="parking-map-container">
                    <div class="parking-legend">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                            <span style="color: white; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Available</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                            <span style="color: white; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Occupied</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                            <span style="color: white; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Visitor</span>
                        </div>
                    </div>
                    <div class="parking-block-selector">
                        <h4 style="color: white; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"><i class="fa-solid fa-building"></i> Select Block</h4>
                        <button class="parking-block-btn active" id="parking-block-btn-A" onclick="showParkingBlock('A')" style="background: white; color: #667eea;">Block A</button>
                        <button class="parking-block-btn" id="parking-block-btn-B" onclick="showParkingBlock('B')" style="background: rgba(255,255,255,0.3); color: white;">Block B</button>
                        <button class="parking-block-btn" id="parking-block-btn-C" onclick="showParkingBlock('C')" style="background: rgba(255,255,255,0.3); color: white;">Block C</button>
                    </div>
                    <div id="parking-map-grid" class="parking-grid"></div>
                </div>
            `;

            loadParkingDataFromFirebase();
        }

        function loadParkingDataFromFirebase() {
            database.ref('parkingSpaces').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    parkingData = snapshot.val();
                } else {
                    initializeDefaultParkingData();
                }
                renderParkingMap(currentParkingBlock);
            });
        }

        function initializeDefaultParkingData() {
            const defaultData = {};
            ['A', 'B', 'C'].forEach(block => {
                for (let i = 1; i <= 8; i++) {
                    const spaceId = `${block}-${String(i).padStart(2, '0')}`;
                    defaultData[spaceId] = {
                        id: spaceId,
                        block: block,
                        status: 'available',
                        vehicle: null,
                        tenant: null,
                        owner: null
                    };
                }
            });
            database.ref('parkingSpaces').set(defaultData);
            parkingData = defaultData;
        }

        function normalizeBlockValue(value, fallbackId) {
            if (value) {
                let normalized = value.toString().trim().toUpperCase();
                if (normalized.startsWith('BLOCK')) {
                    normalized = normalized.replace('BLOCK', '').trim();
                }
                if (normalized.length > 1) {
                    normalized = normalized.split('-')[0].trim();
                }
                return normalized.charAt(0) || '';
            }
            if (fallbackId && fallbackId.includes('-')) {
                return fallbackId.split('-')[0].trim().toUpperCase();
            }
            return '';
        }

        window.showParkingBlock = function(block) {
            if (!block) return;
            const normalizedTarget = block.toString().trim().toUpperCase();
            currentParkingBlock = normalizedTarget;
            ['A', 'B', 'C'].forEach(b => {
                const btn = document.getElementById(`parking-block-btn-${b}`);
                if (btn) {
                    if (b === normalizedTarget) {
                        btn.classList.add('active');
                        btn.style.background = 'white';
                        btn.style.color = '#667eea';
                        btn.style.transform = 'scale(1.05)';
                    } else {
                        btn.classList.remove('active');
                        btn.style.background = 'rgba(255,255,255,0.3)';
                        btn.style.color = 'white';
                        btn.style.transform = 'scale(1)';
                    }
                }
            });
            renderParkingMap(block);
        }

        function renderParkingMap(block) {
            const normalizedBlock = (block || '').toString().trim().toUpperCase();
            const grid = document.getElementById('parking-map-grid');
            if (!grid) {
                console.error('Parking map grid not found');
                return;
            }

            const blockSpaces = Object.entries(parkingData || {})
                .filter(([id, space]) => {
                    const derivedBlock = normalizeBlockValue(space && space.block, id);
                    return derivedBlock === normalizedBlock;
                })
                .sort((a, b) => {
                    const numA = parseInt(a[0].split('-')[1]) || 0;
                    const numB = parseInt(b[0].split('-')[1]) || 0;
                    return numA - numB;
                });

            if (blockSpaces.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: white; padding: 40px; grid-column: 1 / -1; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">No parking spaces found for Block ' + block + '.</p>';
                return;
            }

            grid.innerHTML = blockSpaces.map(([id, space]) => {
                const statusClass = space.status || 'available';
                const vehicleInfo = space.vehicle ? `<div style="font-size: 10px; margin-top: 3px; opacity: 0.9;">${space.vehicle}</div>` : '';
                return `
                    <div class="parking-space ${statusClass}" onclick="showParkingDetails('${id}')" data-space-id="${id}">
                        <div class="parking-space-number">${id}</div>
                        <div class="parking-space-status">${statusClass}</div>
                        ${vehicleInfo}
                    </div>
                `;
            }).join('');
        }

        window.showParkingDetails = function(spaceId) {
            const space = parkingData[spaceId];
            if (!space) {
                alert('Parking space not found');
                return;
            }

            const modal = document.getElementById('parking-details-modal');
            const content = document.getElementById('parking-details-content');
            
            content.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Parking Space ID</label>
                        <p style="margin: 0; color: #333; font-size: 24px; font-weight: 700;">${space.id}</p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Status</label>
                            <select id="parking-status-edit" class="form-control">
                                <option value="available" ${space.status === 'available' ? 'selected' : ''}>Available</option>
                                <option value="occupied" ${space.status === 'occupied' ? 'selected' : ''}>Occupied</option>
                                <option value="visitor" ${space.status === 'visitor' ? 'selected' : ''}>Visitor</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Vehicle Registration</label>
                            <input type="text" id="parking-vehicle-edit" class="form-control" value="${space.vehicle || ''}" placeholder="Enter vehicle registration">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Tenant Name</label>
                            <input type="text" id="parking-tenant-edit" class="form-control" value="${space.tenant || ''}" placeholder="Enter tenant name">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 5px;">Owner</label>
                            <input type="text" id="parking-owner-edit" class="form-control" value="${space.owner || ''}" placeholder="Enter owner name">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="saveParkingDetails('${spaceId}')">
                            <i class="fa-solid fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" onclick="closeParkingModal()">
                            <i class="fa-solid fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        };

        window.saveParkingDetails = function(spaceId) {
            const status = document.getElementById('parking-status-edit').value;
            const vehicle = document.getElementById('parking-vehicle-edit').value.trim();
            const tenant = document.getElementById('parking-tenant-edit').value.trim();
            const owner = document.getElementById('parking-owner-edit').value.trim();

            const updates = {
                status: status,
                vehicle: vehicle || null,
                tenant: tenant || null,
                owner: owner || null,
                updatedAt: new Date().toISOString(),
                updatedBy: auth.currentUser ? auth.currentUser.email : 'Security'
            };

            database.ref(`parkingSpaces/${spaceId}`).update(updates)
                .then(() => {
                    alert('Parking space updated successfully!');
                    closeParkingModal();
                })
                .catch((error) => {
                    alert('Error updating parking space: ' + error.message);
                });
        };

        window.closeParkingModal = function() {
            document.getElementById('parking-details-modal').style.display = 'none';
        };
    </script>
</body>
</html>
